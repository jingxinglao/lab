<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ê†°Âõ≠Âç°ÁÆ°ÁêÜÁ≥ªÁªü</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            width: 90%;
            max-width: 1200px;
            min-height: 600px;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.8;
            font-size: 1.1em;
        }

        .main-content {
            padding: 40px;
        }

        .section {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-radius: 15px;
            padding: 5px;
            margin-bottom: 30px;
        }

        .nav-tab {
            flex: 1;
            padding: 15px 20px;
            background: transparent;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
            color: #666;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.3);
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            border: 1px solid #e9ecef;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #4facfe;
        }

        .btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
        }

        .balance-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: center;
            padding: 30px;
        }

        .balance-amount {
            font-size: 3em;
            font-weight: bold;
            margin: 10px 0;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 15px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .info-item:last-child {
            border-bottom: none;
        }

        .records-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .records-table th,
        .records-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .records-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .hidden {
            display: none;
        }

        .user-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
        }

        .welcome-text {
            font-size: 1.2em;
            color: #333;
        }

        .logout-btn {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
        }

        .search-box {
            display: flex;
            margin-bottom: 20px;
        }

        .search-box input {
            flex: 1;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 10px 0 0 10px;
            font-size: 16px;
        }

        .search-box button {
            padding: 10px 20px;
            border: none;
            border-radius: 0 10px 10px 0;
            cursor: pointer;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            transition: background 0.3s ease;
        }

        .search-box button:hover {
            background: linear-gradient(135deg, #00f2fe 0%, #4facfe 100%);
        }

        .export-options {
            display: flex;
            gap: 10px;
        }

        .export-options button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            transition: background 0.3s ease;
        }

        .export-options button:hover {
            background: linear-gradient(135deg, #00f2fe 0%, #4facfe 100%);
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

         /* Êñ∞Â¢ûÔºö‰∫åÁ∫ßÊåâÈíÆÁªÑÊ†∑Âºè */
        .sub-nav {
            display: flex;
            margin-top: 20px;
            border-bottom: 2px solid #e9ecef;
        }
        .sub-nav button {
            flex: 1;
            padding: 10px 0;
            background: transparent;
            border: none;
            font-size: 16px;
            color: #666;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .sub-nav button.active {
            color: #4facfe;
            border-bottom: 3px solid #4facfe;
            font-weight: 600;
        }
        .sub-tab-content {
            display: none;
            margin-top: 20px;
        }
        .sub-tab-content.active {
            display: block;
        }
        /* Êñ∞Â¢ûÔºöË°®Ê†ºÊ†∑ÂºèÔºàÂèÇËÄÉÂéüÊúâ records-tableÔºâ */
        .admin-table {
            width: 100%;
            border-collapse: collapse;
        }
        .admin-table th,
        .admin-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }
        .admin-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
        }

        .pagination button {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            margin: 0 5px;
            transition: background 0.3s ease;
        }

        .pagination button:hover {
            background: linear-gradient(135deg, #00f2fe 0%, #4facfe 100%);
        }

        .pagination span {
            font-size: 16px;
            color: #333;
            margin: 0 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéì Ê†°Âõ≠Âç°ÁÆ°ÁêÜÁ≥ªÁªü</h1>
            <p>Campus Card Management System</p>
        </div>

        <!-- ÁôªÂΩïÈ°µÈù¢ -->
        <div id="login-section" class="section active">
            <div class="main-content">
                <div class="card" style="max-width: 400px; margin: 0 auto;">
                    <h2 style="text-align: center; margin-bottom: 30px; color: #333;">Áî®Êà∑ÁôªÂΩï</h2>
                    
                    <div id="login-alert" class="alert hidden"></div>
                    
                    <form id="login-form">
                        <div class="form-group">
                            <label for="username">Áî®Êà∑ÂêçÊàñÂç°Âè∑</label>
                            <input type="text" id="username" name="username" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="password">ÂØÜÁ†Å</label>
                            <input type="password" id="password" name="password" required>
                        </div>
                        
                        <button type="submit" class="btn" style="width: 100%;">ÁôªÂΩï</button>
                    </form>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <a href="#" onclick="showRegisterForm()" style="color: #4facfe;">ËøòÊ≤°ÊúâË¥¶Âè∑ÔºüÁÇπÂáªÊ≥®ÂÜå</a>
                    </div>
                    
                    <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #e9ecef;">
                        <h4 style="color: #666;">ÊµãËØïË¥¶Âè∑</h4>
                        <p style="color: #888; margin: 10px 0;">ÁÆ°ÁêÜÂëòÔºöadmin / admin123</p>
                        <p style="color: #888;">ÊôÆÈÄöÁî®Êà∑Ôºözhangsan / 123456</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ê≥®ÂÜåÈ°µÈù¢ -->
        <div id="register-section" class="section">
            <div class="main-content">
                <div class="card" style="max-width: 400px; margin: 0 auto;">
                    <h2 style="text-align: center; margin-bottom: 30px; color: #333;">Áî®Êà∑Ê≥®ÂÜå</h2>
                    
                    <div id="register-alert" class="alert hidden"></div>
                    
                    <form id="register-form">
                        <div class="form-group">
                            <label for="reg-username">Áî®Êà∑Âêç</label>
                            <input type="text" id="reg-username" name="username" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="reg-password">ÂØÜÁ†Å</label>
                            <input type="password" id="reg-password" name="password" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="reg-student-id">Â≠¶Âè∑</label>
                            <input type="text" id="reg-student-id" name="student_id" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="reg-name">ÂßìÂêç</label>
                            <input type="text" id="reg-name" name="name" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="reg-department">Èô¢Á≥ª</label>
                            <input type="text" id="reg-department" name="department" required>
                        </div>
                        
                        <button type="submit" class="btn" style="width: 100%;">Ê≥®ÂÜå</button>
                        <button type="button" class="btn" style="width: 100%; margin-top: 10px; background: #ccc;" onclick="showLoginForm()">ËøîÂõûÁôªÂΩï</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Áî®Êà∑‰∏ªÈ°µÈù¢ -->
        <div id="main-section" class="section">
            <div class="main-content">
                <div class="user-info">
                    <div>
                        <span class="welcome-text">Ê¨¢ËøéÂõûÊù•Ôºå<span id="user-name"></span>ÔºÅ</span>
                        <span style="margin-left: 20px; color: #666;">Âç°Âè∑Ôºö<span id="user-card"></span></span>
                    </div>
                    <button class="logout-btn" onclick="logout()">ÈÄÄÂá∫ÁôªÂΩï</button>
                </div>

                <div class="nav-tabs">
                    <button class="nav-tab active" onclick="showTab('profile')">‰∏™‰∫∫‰ø°ÊÅØ</button>
                    <button class="nav-tab" onclick="showTab('records')">Ê∂àË¥πËÆ∞ÂΩï</button>
                    <button class="nav-tab" onclick="showTab('recharge')">Âú®Á∫øÂÖÖÂÄº</button>
                    <button class="nav-tab" onclick="showTab('admin')">Á≥ªÁªüÁÆ°ÁêÜ</button>
                </div>

                <!-- ‰∏™‰∫∫‰ø°ÊÅØ -->
                <div id="profile-tab" class="tab-content">
                    <div class="info-grid">
                        <div class="card balance-card">
                            <h3>ÂΩìÂâç‰ΩôÈ¢ù</h3>
                            <div class="balance-amount">¬•<span id="user-balance">0.00</span></div>
                            <p>Campus Card Balance</p>
                        </div>
                        
                        <div class="card">
                            <h3 style="margin-bottom: 20px;">Âü∫Êú¨‰ø°ÊÅØ</h3>
                            <div id="user-details"></div>
                            <button class="btn" onclick="showEditProfileForm()" style="margin-top: 20px;">‰øÆÊîπ‰∏™‰∫∫‰ø°ÊÅØ</button>
                        </div>
                    </div>
                    
                    <div class="card" style="margin-top: 20px;">
                        <h3 style="margin-bottom: 20px;">ÂÖÖÂÄºËÆ∞ÂΩï</h3>
                        <div id="recharge-history">
                            <p style="text-align: center; color: #666;">Âä†ËΩΩ‰∏≠...</p>
                        </div>
                    </div>
                </div>

                <!-- Ê∂àË¥πËÆ∞ÂΩï -->
                <div id="records-tab" class="tab-content hidden">
                    <div class="card">
                        <h3 style="margin-bottom: 20px;">Ê∂àË¥πËÆ∞ÂΩï</h3>
                        <div id="records-content">
                            <p style="text-align: center; color: #666;">Âä†ËΩΩ‰∏≠...</p>
                        </div>
                    </div>
                </div>

                <!-- Âú®Á∫øÂÖÖÂÄº -->
                <div id="recharge-tab" class="tab-content hidden">
                    <div class="card">
                        <h3 style="margin-bottom: 20px;">Âú®Á∫øÂÖÖÂÄº</h3>
                        <div id="recharge-alert" class="alert hidden"></div>
                        
                        <form id="recharge-form">
                            <div class="form-group">
                                <label for="target-card">ÁõÆÊ†áÂç°Âè∑</label>
                                <input type="text" id="target-card" name="target_card" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="target-password">ÁõÆÊ†áÂç°ÂØÜÁ†Å</label>
                                <input type="password" id="target-password" name="target_password" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="amount">ÂÖÖÂÄºÈáëÈ¢ù</label>
                                <input type="number" id="amount" name="amount" min="1" step="0.01" required>
                            </div>
                            
                            <button type="submit" class="btn">Á°ÆËÆ§ÂÖÖÂÄº</button>
                        </form>
                    </div>
                </div>

                <!-- Á≥ªÁªüÁÆ°ÁêÜ -->
                <div id="admin-tab-content" class="tab-content hidden">
                        <div class="card">
                            <h3>Áî®Êà∑ÁÆ°ÁêÜ</h3>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                            <button onclick="showCreateUserModal()" class="btn">ÂàõÂª∫Êñ∞Áî®Êà∑</button>
                            <div class="search-box" style="display: flex; gap: 10px; width: 70%;">
                                <div style="flex: 1;">
                                <input type="text" id="user-search" placeholder="ÊêúÁ¥¢Áî®Êà∑Âêç/Âç°Âè∑/Â≠¶Âè∑">
                            </div>
                                <div style="flex: 1;">
                                    <input type="text" id="department-search" placeholder="ÊêúÁ¥¢Â≠¶Èô¢" style="width: 100%; padding: 10px; border: 2px solid #e9ecef; border-radius: 10px; font-size: 16px;">
                                </div>
                                <button onclick="searchUsers()" class="btn">ÊêúÁ¥¢</button>
                            </div>
                        </div>
                        <div id="users-table"></div>

                        <!-- Êñ∞Â¢ûÔºöÊìç‰ΩúÊó•ÂøóÈÉ®ÂàÜ -->
                        <div style="margin-top: 40px;">
                            <h3>Êìç‰ΩúÊó•Âøó</h3>
                            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                                <div class="search-box" style="flex: 2;">
                                    <input type="text" id="log-search" list="action-types" placeholder="ÊêúÁ¥¢Êìç‰ΩúÂÜÖÂÆπ">
                                    <datalist id="action-types">
                                        <option value="Áî®Êà∑ÁôªÂΩï">
                                        <option value="ÂàõÂª∫Áî®Êà∑">
                                        <option value="Âà†Èô§Áî®Êà∑">
                                        <option value="‰øÆÊîπ‰∏™‰∫∫‰ø°ÊÅØ">
                                        <option value="‰øÆÊîπÂØÜÁ†Å">
                                        <option value="Âú®Á∫øÂÖÖÂÄº">
                                        <option value="ÂÜªÁªìÁî®Êà∑">
                                        <option value="Ëß£ÂÜªÁî®Êà∑">
                                    </datalist>
                                    <button onclick="searchLogs()" class="btn">ÊêúÁ¥¢Êó•Âøó</button>
                                </div>
                                <div style="flex: 1;">
                                    <select id="operator-filter" style="width: 100%; padding: 10px; border: 2px solid #e9ecef; border-radius: 10px; font-size: 16px;">
                                        <option value="">ÊâÄÊúâÊìç‰Ωú‰∫∫</option>
                                    </select>
                                </div>
                            </div>
                            <div id="logs-table"></div>
                        </div>
                            </div>
                </div>
            </div>
        </div>

        <!-- ‰øÆÊîπ‰∏™‰∫∫‰ø°ÊÅØÊ®°ÊÄÅÊ°Ü -->
        <div id="edit-profile-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <h3>‰øÆÊîπ‰∏™‰∫∫‰ø°ÊÅØ</h3>
                <div id="edit-profile-alert" class="alert hidden"></div>
                <form id="edit-profile-form">
                    <div class="form-group">
                        <label for="edit-name">ÂßìÂêç</label>
                        <input type="text" id="edit-name" name="name">
                    </div>
                    <div class="form-group">
                        <label for="edit-department">Èô¢Á≥ª</label>
                        <input type="text" id="edit-department" name="department">
                    </div>
                    <div class="form-group">
                        <label for="edit-phone">ÊâãÊú∫Âè∑Á†Å</label>
                        <input type="tel" id="edit-phone" name="phone">
                    </div>
                    <div class="form-group">
                        <label for="edit-email">ÈÇÆÁÆ±</label>
                        <input type="email" id="edit-email" name="email">
                    </div>
                    <div class="modal-buttons">
                        <button type="submit" class="btn">‰øùÂ≠ò</button>
                        <button type="button" class="btn" style="background: #ccc;" onclick="hideEditProfileForm()">ÂèñÊ∂à</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- ÂàõÂª∫Áî®Êà∑Ê®°ÊÄÅÊ°Ü -->
        <div id="create-user-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <h3>ÂàõÂª∫Êñ∞Áî®Êà∑</h3>
                <div id="create-user-alert" class="alert hidden"></div>
                <form id="create-user-form">
                    <div class="form-group">
                        <label for="new-username">Áî®Êà∑Âêç</label>
                        <input type="text" id="new-username" name="username" required>
                    </div>
                    <div class="form-group">
                        <label for="new-password">ÂØÜÁ†Å</label>
                        <input type="password" id="new-password" name="password" required>
                    </div>
                    <div class="form-group">
                        <label for="new-name">ÂßìÂêç</label>
                        <input type="text" id="new-name" name="name" required>
                    </div>
                    <div class="form-group">
                        <label for="new-student-id">Â≠¶Âè∑</label>
                        <input type="text" id="new-student-id" name="student_id" required>
                    </div>
                    <div class="form-group">
                        <label for="new-department">Èô¢Á≥ª</label>
                        <input type="text" id="new-department" name="department" required style="width: 100%; padding: 12px 15px; border: 2px solid #e9ecef; border-radius: 10px; font-size: 16px;">
                    </div>
                    <div class="modal-buttons">
                        <button type="submit" class="btn">ÂàõÂª∫</button>
                        <button type="button" class="btn" style="background: #ccc;" onclick="hideCreateUserModal()">ÂèñÊ∂à</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Á°ÆËÆ§Âà†Èô§Áî®Êà∑Ê®°ÊÄÅÊ°Ü -->
        <div id="delete-user-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <h3>Á°ÆËÆ§Âà†Èô§Áî®Êà∑</h3>
                <p>ÊÇ®Á°ÆÂÆöË¶ÅÂà†Èô§Áî®Êà∑ <span id="delete-user-name"></span> ÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ</p>
                <div id="delete-user-alert" class="alert hidden"></div>
                <div class="modal-buttons">
                    <button onclick="confirmDeleteUser()" class="btn btn-danger">Á°ÆËÆ§Âà†Èô§</button>
                    <button onclick="hideDeleteUserModal()" class="btn" style="background: #ccc;">ÂèñÊ∂à</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://127.0.0.1:3000/api';
        let currentUser = JSON.parse(localStorage.getItem('currentUser')) || null;
        let authToken = localStorage.getItem('authToken') || null;
        let userToDelete = null;

        // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÊ£ÄÊü•ÁôªÂΩïÁä∂ÊÄÅ
        document.addEventListener('DOMContentLoaded', () => {
            if (currentUser && authToken) {
                showMainSection();
            }
        });

        // ÁôªÂΩïÂäüËÉΩ
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // ÂÖàÈáçÁΩÆÊâÄÊúâÊòæÁ§∫Áä∂ÊÄÅ
            document.querySelector('.balance-card').style.display = 'block';
            document.querySelector('#recharge-history').parentElement.style.display = 'block';
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            try {
                const response = await fetch(`${API_BASE}/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    authToken = result.token;
                    currentUser = result.user;
                    // ‰øùÂ≠òÁôªÂΩïÁä∂ÊÄÅÂà∞ localStorage
                    localStorage.setItem('authToken', authToken);
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    showAlert('login-alert', 'ÁôªÂΩïÊàêÂäüÔºÅ', 'success');
                    
                    setTimeout(() => {
                        showMainSection();
                    }, 1000);
                } else {
                    showAlert('login-alert', result.error || 'ÁôªÂΩïÂ§±Ë¥•', 'error');
                }
            } catch (error) {
                showAlert('login-alert', 'ÁΩëÁªúÈîôËØØÔºåËØ∑Ê£ÄÊü•ÊúçÂä°Âô®ÊòØÂê¶ÂêØÂä®', 'error');
            }
        });

        // ÊòæÁ§∫‰∏ªÁïåÈù¢
        function showMainSection() {
            document.getElementById('login-section').classList.remove('active');
            document.getElementById('main-section').classList.add('active');
            
            // Êõ¥Êñ∞Áî®Êà∑‰ø°ÊÅØ
            document.getElementById('user-name').textContent = currentUser.name || currentUser.username;
            document.getElementById('user-card').textContent = currentUser.card_number || currentUser.id;
            
            // ÂÖàÊòæÁ§∫ÊâÄÊúâÂÖÉÁ¥†ÔºåÂêéÈù¢ÂÜçÊ†πÊçÆËßíËâ≤ÈöêËóè
            document.querySelector('.balance-card').style.display = 'block';
            document.querySelector('#recharge-history').parentElement.style.display = 'block';
            
            // ÂÖàÈöêËóèÊâÄÊúâÊ†áÁ≠æÈ°µÂÜÖÂÆπ
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => content.classList.add('hidden'));
            
            // ÈáçÁΩÆÊâÄÊúâÂØºËà™Ê†áÁ≠æÁä∂ÊÄÅ
            const navTabs = document.querySelectorAll('.nav-tab');
            navTabs.forEach(tab => {
                tab.classList.remove('active');
                tab.style.display = 'block';  // ÂÖàÊòæÁ§∫ÊâÄÊúâÊ†áÁ≠æ
            });
            
            // Ê†πÊçÆÁî®Êà∑ËßíËâ≤ÊéßÂà∂ÊòæÁ§∫ÂÜÖÂÆπ
            const isAdmin = currentUser.role === 'admin';
            
            if (isAdmin) {
                // ÁÆ°ÁêÜÂëòÈöêËóè‰ΩôÈ¢ùÂíåÂÖÖÂÄºËÆ∞ÂΩï
                document.querySelector('.balance-card').style.display = 'none';
                document.querySelector('#recharge-history').parentElement.style.display = 'none';
                // ÁÆ°ÁêÜÂëòÈöêËóèÊ∂àË¥πËÆ∞ÂΩïÂíåÂú®Á∫øÂÖÖÂÄºÊ†áÁ≠æ
                navTabs.forEach(tab => {
                    if (tab.textContent === 'Ê∂àË¥πËÆ∞ÂΩï' || tab.textContent === 'Âú®Á∫øÂÖÖÂÄº') {
                        tab.style.display = 'none';
                    }
                });
                // ÁÆ°ÁêÜÂëòÈªòËÆ§ÊòæÁ§∫‰∏™‰∫∫‰ø°ÊÅØÊ†áÁ≠æÈ°µ [‰øÆÊîπÊ≠§Â§Ñ]
                document.querySelector('[onclick="showTab(\'profile\')"]').classList.add('active');
                document.getElementById('profile-tab').classList.remove('hidden');
            } else {
                // ÊôÆÈÄöÁî®Êà∑ÈöêËóèÁ≥ªÁªüÁÆ°ÁêÜÊ†áÁ≠æ
                navTabs.forEach(tab => {
                    if (tab.textContent === 'Á≥ªÁªüÁÆ°ÁêÜ') {
                        tab.style.display = 'none';
                    }
                });
                // ÊôÆÈÄöÁî®Êà∑ÈªòËÆ§ÊòæÁ§∫‰∏™‰∫∫‰ø°ÊÅØÊ†áÁ≠æÈ°µ
                document.querySelector('[onclick="showTab(\'profile\')"]').classList.add('active');
                document.getElementById('profile-tab').classList.remove('hidden');
            }
            
            // Âä†ËΩΩÁî®Êà∑ËØ¶ÁªÜ‰ø°ÊÅØ
            loadUserProfile();
        }

        // Âä†ËΩΩÁî®Êà∑‰ø°ÊÅØ
        async function loadUserProfile() {
            try {
                const response = await fetch(`${API_BASE}/profile`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    const user = await response.json();
                    currentUser = { ...currentUser, ...user }; // Êõ¥Êñ∞ÂΩìÂâçÁî®Êà∑‰ø°ÊÅØ
                    document.getElementById('user-balance').textContent = user.balance || '0.00';
                    
                    const detailsHtml = `
                        <div class="info-item">
                            <span><strong>ÂßìÂêç</strong></span>
                            <span>${user.name || 'Êú™ËÆæÁΩÆ'}</span>
                        </div>
                        <div class="info-item">
                            <span><strong>Â≠¶Âè∑</strong></span>
                            <span>${user.student_id || 'Êú™ËÆæÁΩÆ'}</span>
                        </div>
                        <div class="info-item">
                            <span><strong>Èô¢Á≥ª</strong></span>
                            <span>${user.department || 'Êú™ËÆæÁΩÆ'}</span>
                        </div>
                        <div class="info-item">
                            <span><strong>ÊâãÊú∫</strong></span>
                            <span>${user.phone || 'Êú™ËÆæÁΩÆ'}</span>
                        </div>
                        <div class="info-item">
                            <span><strong>ÈÇÆÁÆ±</strong></span>
                            <span>${user.email || 'Êú™ËÆæÁΩÆ'}</span>
                        </div>
                    `;
                    document.getElementById('user-details').innerHTML = detailsHtml;
                    
                    // Á´ãÂç≥Âä†ËΩΩÂÖÖÂÄºËÆ∞ÂΩï
                    await loadRechargeHistory();
                }
            } catch (error) {
                console.error('Âä†ËΩΩÁî®Êà∑‰ø°ÊÅØÂ§±Ë¥•:', error);
            }
        }

        // Âä†ËΩΩÊ∂àË¥πËÆ∞ÂΩï
        async function loadRecords() {
            try {
                const response = await fetch(`${API_BASE}/consumption-records`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const records = data.records || [];
                    
                    if (records.length === 0) {
                        document.getElementById('records-content').innerHTML = '<p style="text-align: center; color: #666;">ÊöÇÊó†Ê∂àË¥πËÆ∞ÂΩï</p>';
                        return;
                    }
                    
                    const tableHtml = `
                        <table class="records-table">
                            <thead>
                                <tr>
                                    <th>Êó∂Èó¥</th>
                                    <th>ÂïÜÊà∑</th>
                                    <th>Ê∂àË¥πËØ¥Êòé</th>
                                    <th>ÈáëÈ¢ù</th>
                                    <th>‰ΩôÈ¢ù</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${records.map(record => `
                                    <tr>
                                        <td>${new Date(record.created_at).toLocaleString()}</td>
                                        <td>${record.merchant}</td>
                                        <td>${record.description}</td>
                                        <td style="color: #ff6b6b;">-¬•${record.amount}</td>
                                        <td>¬•${record.balance_after}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                    document.getElementById('records-content').innerHTML = tableHtml;
                }
            } catch (error) {
                document.getElementById('records-content').innerHTML = '<p style="text-align: center; color: #ff6b6b;">Âä†ËΩΩÂ§±Ë¥•</p>';
            }
        }

        // ÂÖÖÂÄºÂäüËÉΩ
        document.getElementById('recharge-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const rechargeData = {
                target_card: formData.get('target_card'),
                target_password: formData.get('target_password'),
                amount: parseFloat(formData.get('amount'))
            };
            
            try {
                const response = await fetch(`${API_BASE}/recharge`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(rechargeData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showAlert('recharge-alert', `ÊàêÂäüÂêë${result.to_user}ËΩ¨Ë¥¶ ¬•${rechargeData.amount}`, 'success');
                    e.target.reset();
                    
                    // Êõ¥Êñ∞ÊòæÁ§∫ÁöÑ‰ΩôÈ¢ùÂíåÈáçÊñ∞Âä†ËΩΩÂÖÖÂÄºËÆ∞ÂΩï
                    const balanceElement = document.getElementById('user-balance');
                    balanceElement.textContent = result.new_balance.toFixed(2);
                    await loadUserProfile(); // ÈáçÊñ∞Âä†ËΩΩÊâÄÊúâÁî®Êà∑‰ø°ÊÅØÂíåÂÖÖÂÄºËÆ∞ÂΩï
                } else {
                    showAlert('recharge-alert', result.error || 'ÂÖÖÂÄºÂ§±Ë¥•', 'error');
                }
            } catch (error) {
                showAlert('recharge-alert', 'ÁΩëÁªúÈîôËØØ', 'error');
            }
        });

        // Ê†áÁ≠æÈ°µÂàáÊç¢
        function showTab(tabName) {
            // Ê£ÄÊü•ÊòØÂê¶ÊòØÁÆ°ÁêÜÂëò
            if (currentUser.role === 'admin') {
                if (tabName === 'records' || tabName === 'recharge') {
                    return; // ÁÆ°ÁêÜÂëò‰∏çÂÖÅËÆ∏ËÆøÈóÆËøô‰∫õÊ†áÁ≠æÈ°µ
                }
            }

            // Êõ¥Êñ∞ÂØºËà™Ê†áÁ≠æ
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            // ÈöêËóèÊâÄÊúâÊ†áÁ≠æÈ°µÂÜÖÂÆπ
            document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
            
            // ÊòæÁ§∫ÊåáÂÆöÊ†áÁ≠æÈ°µ
            const targetTab = document.getElementById(`${tabName}-tab`) || document.getElementById(`${tabName}-tab-content`);
            if (targetTab) {
                targetTab.classList.remove('hidden');
            }
            
            // Âä†ËΩΩÁõ∏Â∫îÊï∞ÊçÆ
            if (tabName === 'records') {
                loadRecords();
            } else if (tabName === 'admin') {
                loadAdminDashboard();
            } else if (tabName === 'profile') {
                // ÂàáÊç¢Âà∞‰∏™‰∫∫‰ø°ÊÅØÊ†áÁ≠æÈ°µÊó∂ÈáçÊñ∞Âä†ËΩΩÁî®Êà∑‰ø°ÊÅØ
                loadUserProfile();
            }
        }

        // ÊòæÁ§∫ÊèêÁ§∫‰ø°ÊÅØ
        function showAlert(elementId, message, type) {
            const alertElement = document.getElementById(elementId);
            alertElement.className = `alert alert-${type}`;
            alertElement.textContent = message;
            alertElement.classList.remove('hidden');
            
            // 3ÁßíÂêéËá™Âä®ÈöêËóèÊèêÁ§∫‰ø°ÊÅØ
            setTimeout(() => {
                alertElement.classList.add('hidden');
                alertElement.textContent = '';
            }, 3000);
        }

        // Ê∏ÖÈô§ÊâÄÊúâÊèêÁ§∫‰ø°ÊÅØ
        function clearAllAlerts() {
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(alert => {
                alert.classList.add('hidden');
                alert.textContent = '';
            });
        }

        // ÈÄÄÂá∫ÁôªÂΩï
        function logout() {
            currentUser = null;
            authToken = null;
            // Ê∏ÖÈô§Êú¨Âú∞Â≠òÂÇ®ÁöÑÁôªÂΩïÁä∂ÊÄÅ
            localStorage.removeItem('currentUser');
            localStorage.removeItem('authToken');
            
            // ÈáçÁΩÆÊòæÁ§∫Áä∂ÊÄÅ
            document.querySelector('.balance-card').style.display = 'block';
            document.querySelector('#recharge-history').parentElement.style.display = 'block';
            const navTabs = document.querySelectorAll('.nav-tab');
            navTabs.forEach(tab => {
                tab.style.display = 'block';
            });
            
            // ÈáçÁΩÆÊâÄÊúâÊòæÁ§∫Áä∂ÊÄÅ
            document.getElementById('main-section').classList.remove('active');
            document.getElementById('login-section').classList.add('active');
            
            // Ê∏ÖÁêÜË°®Ê†ºÂÜÖÂÆπ
            document.getElementById('users-table').innerHTML = '';
            document.getElementById('logs-table').innerHTML = '';
            
            // ÈáçÁΩÆË°®Âçï
            document.getElementById('login-form').reset();
            
            // Ê∏ÖÈô§ÊâÄÊúâÊèêÁ§∫‰ø°ÊÅØ
            clearAllAlerts();
        }

        // ÊòæÁ§∫Ê≥®ÂÜåË°®Âçï
        function showRegisterForm() {
            document.getElementById('login-section').classList.remove('active');
            document.getElementById('register-section').classList.add('active');
            clearAllAlerts(); // ÂàáÊç¢Ë°®ÂçïÊó∂Ê∏ÖÈô§ÊèêÁ§∫‰ø°ÊÅØ
        }

        // ËøîÂõûÁôªÂΩïË°®Âçï
        function showLoginForm() {
            document.getElementById('register-section').classList.remove('active');
            document.getElementById('login-section').classList.add('active');
            clearAllAlerts(); // ÂàáÊç¢Ë°®ÂçïÊó∂Ê∏ÖÈô§ÊèêÁ§∫‰ø°ÊÅØ
        }

        // Â§ÑÁêÜÊ≥®ÂÜåË°®ÂçïÊèê‰∫§
        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const registerData = Object.fromEntries(formData.entries());
            
            try {
                const response = await fetch(`${API_BASE}/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(registerData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showAlert('register-alert', 'Ê≥®ÂÜåÊàêÂäüÔºÅËØ∑ÁôªÂΩï', 'success');
                    setTimeout(() => {
                        showLoginForm();
                        e.target.reset();
                    }, 1500);
                } else {
                    showAlert('register-alert', result.error || 'Ê≥®ÂÜåÂ§±Ë¥•', 'error');
                }
            } catch (error) {
                showAlert('register-alert', 'ÁΩëÁªúÈîôËØØ', 'error');
            }
        });

        // Âä†ËΩΩÂÖÖÂÄºËÆ∞ÂΩï
        async function loadRechargeHistory() {
            try {
                const response = await fetch(`${API_BASE}/recharge-records?limit=50`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const records = data.records || [];
                    
                    if (records.length === 0) {
                        document.getElementById('recharge-history').innerHTML = 
                            '<p style="text-align: center; color: #666;">ÊöÇÊó†ÂÖÖÂÄºËÆ∞ÂΩï</p>';
                        return;
                    }
                    
                    const tableHtml = `
                        <table class="records-table">
                            <thead>
                                <tr>
                                    <th>Êó∂Èó¥</th>
                                    <th>Á±ªÂûã</th>
                                    <th>ÈáëÈ¢ù</th>
                                    <th>Áä∂ÊÄÅ</th>
                                    <th>Â§áÊ≥®</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${records.map(record => `
                                    <tr>
                                        <td>${new Date(record.created_at).toLocaleString()}</td>
                                        <td>${record.method === 'transfer' ? 'ËΩ¨Ë¥¶' : 'Âú®Á∫øÂÖÖÂÄº'}</td>
                                        <td style="color: #4facfe;">+¬•${record.amount}</td>
                                        <td>${record.status === 'completed' ? 'ÊàêÂäü' : 'Â§ÑÁêÜ‰∏≠'}</td>
                                        <td>${record.remark || '-'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                    document.getElementById('recharge-history').innerHTML = tableHtml;
                }
            } catch (error) {
                console.error('Âä†ËΩΩÂÖÖÂÄºËÆ∞ÂΩïÂ§±Ë¥•:', error);
                document.getElementById('recharge-history').innerHTML = 
                    '<p style="text-align: center; color: #ff6b6b;">Âä†ËΩΩÂ§±Ë¥•ÔºåËØ∑ÈáçËØï</p>';
            }
        }

        // ‰øÆÊîπÂä†ËΩΩÁÆ°ÁêÜÂëò‰ª™Ë°®ÁõòÂáΩÊï∞
        async function loadAdminDashboard() {
            try {
                const response = await fetch(`${API_BASE}/admin/users`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    // È¶ñÊ¨°Âä†ËΩΩÊó∂Ë∞ÉÁî® loadUsers Âíå loadLogs
                    await Promise.all([
                        loadUsers(1),  // Âä†ËΩΩÁ¨¨‰∏ÄÈ°µÁî®Êà∑Êï∞ÊçÆ
                        loadLogs(1),    // Âä†ËΩΩÁ¨¨‰∏ÄÈ°µÊó•ÂøóÊï∞ÊçÆ
                        loadOperators() // Âä†ËΩΩÊìç‰Ωú‰∫∫ÂàóË°®
                    ]);
                } else if (response.status === 403) {
                    document.getElementById('users-table').innerHTML = 
                        '<p style="text-align: center; color: #ff6b6b;">ÊÇ®Ê≤°ÊúâÊùÉÈôêËÆøÈóÆÊ≠§ÂäüËÉΩ</p>';
                }
            } catch (error) {
                console.error('Âä†ËΩΩÁÆ°ÁêÜÂëò‰ª™Ë°®ÁõòÂ§±Ë¥•:', error);
                document.getElementById('users-table').innerHTML = 
                    '<p style="text-align: center; color: #ff6b6b;">Âä†ËΩΩÂ§±Ë¥•ÔºåËØ∑ÈáçËØï</p>';
            }
        }

        let currentPage = 1; // Áî®Êà∑ÂàóË°®ÂΩìÂâçÈ°µ
        let currentLogPage = 1; // Êó•ÂøóÂàóË°®ÂΩìÂâçÈ°µ
        let totalPages = 1; // Áî®Êà∑ÂàóË°®ÊÄªÈ°µÊï∞
        let totalLogPages = 1; // Êó•ÂøóÂàóË°®ÊÄªÈ°µÊï∞

        // Âä†ËΩΩÁî®Êà∑ÂàóË°®
        async function loadUsers(page = 1) {
            try {
                const response = await fetch(`${API_BASE}/admin/users?page=${page}&limit=10`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    currentPage = page;
                    totalPages = data.pages;
                    const users = data.users || [];
                    
                    if (users.length === 0) {
                        document.getElementById('users-table').innerHTML = 
                            '<p style="text-align: center; color: #666;">ÊöÇÊó†Áî®Êà∑Êï∞ÊçÆ</p>';
                        return;
                    }
                    
                    const tableHtml = `
                        <table class="records-table">
                            <thead>
                                <tr>
                                    <th>Áî®Êà∑Âêç</th>
                                    <th>ÂßìÂêç</th>
                                    <th>Â≠¶Âè∑</th>
                                    <th>Èô¢Á≥ª</th>
                                    <th>Âç°Âè∑</th>
                                    <th>‰ΩôÈ¢ù</th>
                                    <th>Áä∂ÊÄÅ</th>
                                    <th>Ê≥®ÂÜåÊó∂Èó¥</th>
                                    <th>Êìç‰Ωú</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${users.map(user => `
                                    <tr data-user-id="${user.id}">
                                        <td>${user.username}</td>
                                        <td>${user.name || '-'}</td>
                                        <td>${user.student_id || '-'}</td>
                                        <td>${user.department || '-'}</td>
                                        <td>${user.card_number || '-'}</td>
                                        <td>¬•${user.balance || '0.00'}</td>
                                        <td>${user.status === 'active' ? 'Ê≠£Â∏∏' : 'Â∑≤ÂÜªÁªì'}</td>
                                        <td>${new Date(user.created_at).toLocaleString()}</td>
                                        <td>
                                            <div style="display: flex; gap: 5px;">
                                                <button onclick='showDeleteUserModal(${JSON.stringify(user).replace(/'/g, "\\'")})' class="btn btn-danger" style="padding: 5px 10px; font-size: 14px;">Âà†Èô§</button>
                                                <button onclick='toggleUserStatus(${JSON.stringify(user).replace(/'/g, "\\'")})' class="btn ${user.status === 'active' ? 'btn-danger' : 'btn-success'}" style="padding: 5px 10px; font-size: 14px;">
                                                    ${user.status === 'active' ? 'ÂÜªÁªì' : 'Ëß£ÂÜª'}
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        <div class="pagination">
                            <button onclick="loadUsers(${page - 1})" 
                                    ${page <= 1 ? 'disabled' : ''}>‰∏ä‰∏ÄÈ°µ</button>
                            <span>Á¨¨ ${page} È°µ / ÂÖ± ${data.pages} È°µ</span>
                            <button onclick="loadUsers(${page + 1})"
                                    ${page >= data.pages ? 'disabled' : ''}>‰∏ã‰∏ÄÈ°µ</button>
                        </div>
                    `;
                    document.getElementById('users-table').innerHTML = tableHtml;
                }
            } catch (error) {
                console.error('Âä†ËΩΩÁî®Êà∑ÂàóË°®Â§±Ë¥•:', error);
                document.getElementById('users-table').innerHTML = 
                    '<p style="text-align: center; color: #ff6b6b;">Âä†ËΩΩÂ§±Ë¥•ÔºåËØ∑ÈáçËØï</p>';
            }
        }

        // Âä†ËΩΩÊìç‰ΩúÊó•Âøó
        async function loadLogs(page = 1) {
            try {
                const response = await fetch(`${API_BASE}/admin/logs?page=${page}&limit=10`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    currentLogPage = page;
                    totalLogPages = data.pages;
                    const logs = data.logs || [];
                    
                    if (logs.length === 0) {
                        document.getElementById('logs-table').innerHTML = 
                            '<p style="text-align: center; color: #666;">ÊöÇÊó†Êìç‰ΩúÊó•Âøó</p>';
                        return;
                    }
                    
                    const tableHtml = `
                        <table class="records-table">
                            <thead>
                                <tr>
                                    <th>Êìç‰ΩúÊó∂Èó¥</th>
                                    <th>Êìç‰ΩúÁ±ªÂûã</th>
                                    <th>Êìç‰ΩúÂÜÖÂÆπ</th>
                                    <th>Êìç‰Ωú‰∫∫</th>
                                    <th>IPÂú∞ÂùÄ</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${logs.map(log => `
                                    <tr>
                                        <td>${new Date(log.created_at).toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' })}</td>
                                        <td>${log.action_type}</td>
                                        <td>${log.action_content}</td>
                                        <td>${log.operator_card || '-'}</td>
                                        <td>${log.ip_address}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        <div class="pagination">
                            <button onclick="loadLogs(${page - 1})"
                                    ${page <= 1 ? 'disabled' : ''}>‰∏ä‰∏ÄÈ°µ</button>
                            <span>Á¨¨ ${page} È°µ / ÂÖ± ${data.pages} È°µ</span>
                            <button onclick="loadLogs(${page + 1})"
                                    ${page >= data.pages ? 'disabled' : ''}>‰∏ã‰∏ÄÈ°µ</button>
                        </div>
                    `;
                    document.getElementById('logs-table').innerHTML = tableHtml;
                }
            } catch (error) {
                console.error('Âä†ËΩΩÊìç‰ΩúÊó•ÂøóÂ§±Ë¥•:', error);
                document.getElementById('logs-table').innerHTML = 
                    '<p style="text-align: center; color: #ff6b6b;">Âä†ËΩΩÂ§±Ë¥•ÔºåËØ∑ÈáçËØï</p>';
            }
        }

        // ÊêúÁ¥¢Áî®Êà∑
        async function searchUsers(page = 1) {
            const searchTerm = document.getElementById('user-search').value.trim();
            const department = document.getElementById('department-search').value;
            
            try {
                let url = `${API_BASE}/admin/users?page=${page}&limit=10`;
                if (searchTerm) {
                    url += `&search=${encodeURIComponent(searchTerm)}`;
                }
                if (department) {
                    url += `&department=${encodeURIComponent(department)}`;
                }
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    currentPage = page;
                    totalPages = data.pages;
                    const users = data.users || [];
                    
                    if (users.length === 0) {
                        document.getElementById('users-table').innerHTML = 
                            '<p style="text-align: center; color: #666;">Êú™ÊâæÂà∞ÂåπÈÖçÁöÑÁî®Êà∑</p>';
                        return;
                    }
                    
                    const tableHtml = `
                        <table class="records-table">
                            <thead>
                                <tr>
                                    <th>Áî®Êà∑Âêç</th>
                                    <th>ÂßìÂêç</th>
                                    <th>Â≠¶Âè∑</th>
                                    <th>Èô¢Á≥ª</th>
                                    <th>Âç°Âè∑</th>
                                    <th>‰ΩôÈ¢ù</th>
                                    <th>Áä∂ÊÄÅ</th>
                                    <th>Ê≥®ÂÜåÊó∂Èó¥</th>
                                    <th>Êìç‰Ωú</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${users.map(user => `
                                    <tr data-user-id="${user.id}">
                                        <td>${user.username}</td>
                                        <td>${user.name || '-'}</td>
                                        <td>${user.student_id || '-'}</td>
                                        <td>${user.department || '-'}</td>
                                        <td>${user.card_number || '-'}</td>
                                        <td>¬•${user.balance || '0.00'}</td>
                                        <td>${user.status === 'active' ? 'Ê≠£Â∏∏' : 'Â∑≤ÂÜªÁªì'}</td>
                                        <td>${new Date(user.created_at).toLocaleString()}</td>
                                        <td>
                                            <div style="display: flex; gap: 5px;">
                                                <button onclick='showDeleteUserModal(${JSON.stringify(user).replace(/'/g, "\\'")})' class="btn btn-danger" style="padding: 5px 10px; font-size: 14px;">Âà†Èô§</button>
                                                <button onclick='toggleUserStatus(${JSON.stringify(user).replace(/'/g, "\\'")})' class="btn ${user.status === 'active' ? 'btn-danger' : 'btn-success'}" style="padding: 5px 10px; font-size: 14px;">
                                                    ${user.status === 'active' ? 'ÂÜªÁªì' : 'Ëß£ÂÜª'}
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        <div class="pagination">
                            <button onclick="searchUsers(${page - 1})" 
                                    ${page <= 1 ? 'disabled' : ''}>‰∏ä‰∏ÄÈ°µ</button>
                            <span>Á¨¨ ${page} È°µ / ÂÖ± ${data.pages} È°µ</span>
                            <button onclick="searchUsers(${page + 1})"
                                    ${page >= data.pages ? 'disabled' : ''}>‰∏ã‰∏ÄÈ°µ</button>
                        </div>
                    `;
                    document.getElementById('users-table').innerHTML = tableHtml;
                } else if (response.status === 403) {
                    document.getElementById('users-table').innerHTML = 
                        '<p style="text-align: center; color: #ff6b6b;">ÊÇ®Ê≤°ÊúâÊùÉÈôêËÆøÈóÆÊ≠§ÂäüËÉΩ</p>';
                }
            } catch (error) {
                console.error('ÊêúÁ¥¢Áî®Êà∑Â§±Ë¥•:', error);
                document.getElementById('users-table').innerHTML = 
                    '<p style="text-align: center; color: #ff6b6b;">ÊêúÁ¥¢Â§±Ë¥•ÔºåËØ∑ÈáçËØï</p>';
            }
        }

        // ÊêúÁ¥¢Êìç‰ΩúÊó•Âøó
        async function searchLogs(page = 1) {
            const searchTerm = document.getElementById('log-search').value.trim();
            const operatorCard = document.getElementById('operator-filter').value;
            
            try {
                let url = `${API_BASE}/admin/logs?page=${page}&limit=10`;
                if (searchTerm) {
                    url += `&search=${encodeURIComponent(searchTerm)}`;
                }
                if (operatorCard) {
                    url += `&operator=${encodeURIComponent(operatorCard)}`;
                }
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    currentLogPage = page;
                    totalLogPages = data.pages;
                    const logs = data.logs || [];
                    
                    if (logs.length === 0) {
                        document.getElementById('logs-table').innerHTML = 
                            '<p style="text-align: center; color: #666;">Êú™ÊâæÂà∞ÂåπÈÖçÁöÑÊìç‰ΩúÊó•Âøó</p>';
                        return;
                    }
                    
                    const tableHtml = `
                        <table class="records-table">
                            <thead>
                                <tr>
                                    <th>Êìç‰ΩúÊó∂Èó¥</th>
                                    <th>Êìç‰ΩúÁ±ªÂûã</th>
                                    <th>Êìç‰ΩúÂÜÖÂÆπ</th>
                                    <th>Êìç‰Ωú‰∫∫</th>
                                    <th>IPÂú∞ÂùÄ</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${logs.map(log => `
                                    <tr>
                                        <td>${new Date(log.created_at).toLocaleString()}</td>
                                        <td>${log.action_type}</td>
                                        <td>${log.action_content}</td>
                                        <td>${log.operator}</td>
                                        <td>${log.ip_address}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        <div class="pagination">
                            <button onclick="searchLogs(${page - 1})"
                                    ${page <= 1 ? 'disabled' : ''}>‰∏ä‰∏ÄÈ°µ</button>
                            <span>Á¨¨ ${page} È°µ / ÂÖ± ${data.pages} È°µ</span>
                            <button onclick="searchLogs(${page + 1})"
                                    ${page >= data.pages ? 'disabled' : ''}>‰∏ã‰∏ÄÈ°µ</button>
                        </div>
                    `;
                    document.getElementById('logs-table').innerHTML = tableHtml;
                }
            } catch (error) {
                console.error('ÊêúÁ¥¢Êìç‰ΩúÊó•ÂøóÂ§±Ë¥•:', error);
                document.getElementById('logs-table').innerHTML = 
                    '<p style="text-align: center; color: #ff6b6b;">ÊêúÁ¥¢Â§±Ë¥•ÔºåËØ∑ÈáçËØï</p>';
            }
        }

        // ÊòæÁ§∫ÂàõÂª∫Áî®Êà∑Ê®°ÊÄÅÊ°Ü
        function showCreateUserModal() {
            const modal = document.getElementById('create-user-modal');
            modal.style.display = 'flex';
            document.getElementById('create-user-form').reset();
        }

        // ÈöêËóèÂàõÂª∫Áî®Êà∑Ê®°ÊÄÅÊ°Ü
        function hideCreateUserModal() {
            const modal = document.getElementById('create-user-modal');
            modal.style.display = 'none';
        }

        // ÊòæÁ§∫Âà†Èô§Áî®Êà∑Á°ÆËÆ§Ê®°ÊÄÅÊ°Ü
        function showDeleteUserModal(user) {
            userToDelete = user;
            const modal = document.getElementById('delete-user-modal');
            document.getElementById('delete-user-name').textContent = user.username;
            modal.style.display = 'flex';
        }

        // ÈöêËóèÂà†Èô§Áî®Êà∑Á°ÆËÆ§Ê®°ÊÄÅÊ°Ü
        function hideDeleteUserModal() {
            const modal = document.getElementById('delete-user-modal');
            modal.style.display = 'none';
            userToDelete = null;
        }

        // Â§ÑÁêÜÂàõÂª∫Áî®Êà∑Ë°®ÂçïÊèê‰∫§
        document.getElementById('create-user-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const userData = Object.fromEntries(formData.entries());
            
            try {
                const response = await fetch(`${API_BASE}/admin/users`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(userData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showAlert('create-user-alert', 'Áî®Êà∑ÂàõÂª∫ÊàêÂäü', 'success');
                    // ËÆ∞ÂΩïÂàõÂª∫Áî®Êà∑Êó•Âøó
                    await recordLog('ÂàõÂª∫Áî®Êà∑', `ÂàõÂª∫Áî®Êà∑Ôºö${userData.username}`);
                    setTimeout(() => {
                        hideCreateUserModal();
                        loadUsers();
                        loadLogs(); // ÈáçÊñ∞Âä†ËΩΩÊó•Âøó
                    }, 1500);
                } else {
                    showAlert('create-user-alert', result.error || 'ÂàõÂª∫Áî®Êà∑Â§±Ë¥•', 'error');
                }
            } catch (error) {
                showAlert('create-user-alert', 'ÁΩëÁªúÈîôËØØ', 'error');
            }
        });

        // Á°ÆËÆ§Âà†Èô§Áî®Êà∑
        async function confirmDeleteUser() {
            if (!userToDelete) return;
            
            try {
                const response = await fetch(`${API_BASE}/admin/users/${userToDelete.id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showAlert('delete-user-alert', 'Áî®Êà∑Âà†Èô§ÊàêÂäü', 'success');
                    // ËÆ∞ÂΩïÂà†Èô§Áî®Êà∑Êó•Âøó
                    await recordLog('Âà†Èô§Áî®Êà∑', `Âà†Èô§Áî®Êà∑Ôºö${userToDelete.username}`);
                    setTimeout(() => {
                        hideDeleteUserModal();
                        loadUsers();
                        loadLogs(); // ÈáçÊñ∞Âä†ËΩΩÊó•Âøó
                    }, 1500);
                } else {
                    showAlert('delete-user-alert', result.error || 'Âà†Èô§Áî®Êà∑Â§±Ë¥•', 'error');
                }
            } catch (error) {
                showAlert('delete-user-alert', 'ÁΩëÁªúÈîôËØØ', 'error');
            }
        }

        // ËÆ∞ÂΩïÊìç‰ΩúÊó•Âøó
        async function recordLog(actionType, actionContent) {
            try {
                await fetch(`${API_BASE}/admin/logs`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        action_type: actionType,
                        action_content: actionContent,
                        operator_card: currentUser.card_number
                    })
                });
            } catch (error) {
                console.error('ËÆ∞ÂΩïÊìç‰ΩúÊó•ÂøóÂ§±Ë¥•:', error);
            }
        }

        // Âä†ËΩΩÊìç‰Ωú‰∫∫ÂàóË°®
        async function loadOperators() {
            try {
                const response = await fetch(`${API_BASE}/admin/operators`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    const operators = await response.json();
                    const selectElement = document.getElementById('operator-filter');
                    
                    // Ê∏ÖÈô§Áé∞ÊúâÈÄâÈ°πÔºåÂè™‰øùÁïôÈªòËÆ§ÈÄâÈ°π
                    while (selectElement.options.length > 1) {
                        selectElement.remove(1);
                    }
                    
                    // ‰ΩøÁî® Set ÂéªÈáç
                    const uniqueOperators = Array.from(new Set(operators.map(op => 
                        JSON.stringify({card_number: op.card_number, name: op.name})
                    ))).map(str => JSON.parse(str));
                    
                    // Ê∑ªÂä†Êñ∞ÈÄâÈ°π
                    uniqueOperators.forEach(op => {
                        const option = document.createElement('option');
                        option.value = op.card_number;
                        option.textContent = `${op.name} (${op.card_number})`;
                        selectElement.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Âä†ËΩΩÊìç‰Ωú‰∫∫ÂàóË°®Â§±Ë¥•:', error);
            }
        }

        // ÊòæÁ§∫‰øÆÊîπ‰∏™‰∫∫‰ø°ÊÅØÊ®°ÊÄÅÊ°Ü
        function showEditProfileForm() {
            const modal = document.getElementById('edit-profile-modal');
            // Â°´ÂÖÖÂΩìÂâçÁî®Êà∑‰ø°ÊÅØ
            document.getElementById('edit-name').value = currentUser.name || '';
            document.getElementById('edit-department').value = currentUser.department || '';
            document.getElementById('edit-phone').value = currentUser.phone || '';
            document.getElementById('edit-email').value = currentUser.email || '';
            modal.style.display = 'flex';
        }

        // ÈöêËóè‰øÆÊîπ‰∏™‰∫∫‰ø°ÊÅØÊ®°ÊÄÅÊ°Ü
        function hideEditProfileForm() {
            const modal = document.getElementById('edit-profile-modal');
            modal.style.display = 'none';
        }

        // Â§ÑÁêÜ‰øÆÊîπ‰∏™‰∫∫‰ø°ÊÅØË°®ÂçïÊèê‰∫§
        document.getElementById('edit-profile-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const profileData = Object.fromEntries(formData.entries());

            try {
                const response = await fetch(`${API_BASE}/profile`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(profileData)
                });

                const result = await response.json();
                
                if (response.ok) {
                    showAlert('edit-profile-alert', '‰∏™‰∫∫‰ø°ÊÅØÊõ¥Êñ∞ÊàêÂäü', 'success');
                    await loadUserProfile(); // ÈáçÊñ∞Âä†ËΩΩÁî®Êà∑‰ø°ÊÅØ
                    setTimeout(hideEditProfileForm, 1500);
                } else {
                    showAlert('edit-profile-alert', result.error || 'Êõ¥Êñ∞Â§±Ë¥•', 'error');
                }
            } catch (error) {
                showAlert('edit-profile-alert', 'ÁΩëÁªúÈîôËØØ', 'error');
            }
        });

        // Ê∑ªÂä†Áî®Êà∑ÂÜªÁªì/Ëß£ÂÜªÂäüËÉΩ
        async function toggleUserStatus(user) {
            const newStatus = user.status === 'active' ? 'frozen' : 'active';
            try {
                const response = await fetch(`${API_BASE}/admin/users/${user.id}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ status: newStatus })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    // Êõ¥Êñ∞Êú¨Âú∞Áî®Êà∑Áä∂ÊÄÅ
                    user.status = newStatus;
                    
                    // ËÆ∞ÂΩïÊìç‰ΩúÊó•Âøó
                    await recordLog(
                        newStatus === 'active' ? 'Ëß£ÂÜªÁî®Êà∑' : 'ÂÜªÁªìÁî®Êà∑',
                        `${newStatus === 'active' ? 'Ëß£ÂÜª' : 'ÂÜªÁªì'}Áî®Êà∑Ôºö${user.username}`
                    );
                    
                    // Êõ¥Êñ∞ÂΩìÂâçË°åÁöÑÊòæÁ§∫
                    const userRow = document.querySelector(`tr[data-user-id="${user.id}"]`);
                    if (userRow) {
                        // Êõ¥Êñ∞Áä∂ÊÄÅÂàó
                        const statusCell = userRow.querySelector('td:nth-child(7)');
                        if (statusCell) {
                            statusCell.textContent = user.status === 'active' ? 'Ê≠£Â∏∏' : 'Â∑≤ÂÜªÁªì';
                        }
                        
                        // Êõ¥Êñ∞ÊåâÈíÆ
                        const toggleButton = userRow.querySelector('td:last-child button:last-child');
                        if (toggleButton) {
                            toggleButton.textContent = user.status === 'active' ? 'ÂÜªÁªì' : 'Ëß£ÂÜª';
                            toggleButton.className = `btn ${user.status === 'active' ? 'btn-danger' : 'btn-success'}`;
                            toggleButton.style.padding = '5px 10px';
                            toggleButton.style.fontSize = '14px';
                            
                            // Êõ¥Êñ∞ÊåâÈíÆÁöÑÁÇπÂáª‰∫ã‰ª∂Â§ÑÁêÜÁ®ãÂ∫è
                            toggleButton.onclick = () => toggleUserStatus({
                                ...user,
                                status: newStatus // ‰ΩøÁî®Êõ¥Êñ∞ÂêéÁöÑÁä∂ÊÄÅ
                            });
                        }
                    }
                    
                    showAlert('users-alert', `Áî®Êà∑${newStatus === 'active' ? 'Ëß£ÂÜª' : 'ÂÜªÁªì'}ÊàêÂäü`, 'success');
                    await loadLogs(1); // ÈáçÊñ∞Âä†ËΩΩÊó•Âøó
                } else {
                    showAlert('users-alert', result.error || 'Êìç‰ΩúÂ§±Ë¥•', 'error');
                }
            } catch (error) {
                showAlert('users-alert', 'ÁΩëÁªúÈîôËØØ', 'error');
            }
        }
    </script>
</body>
</html>