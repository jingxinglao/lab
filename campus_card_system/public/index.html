<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ ¡å›­å¡ç®¡ç†ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            width: 90%;
            max-width: 1200px;
            min-height: 600px;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.8;
            font-size: 1.1em;
        }

        .main-content {
            padding: 40px;
        }

        .section {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-radius: 15px;
            padding: 5px;
            margin-bottom: 30px;
        }

        .nav-tab {
            flex: 1;
            padding: 15px 20px;
            background: transparent;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
            color: #666;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.3);
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            border: 1px solid #e9ecef;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #4facfe;
        }

        .btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
        }

        .balance-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: center;
            padding: 30px;
        }

        .balance-amount {
            font-size: 3em;
            font-weight: bold;
            margin: 10px 0;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 15px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .info-item:last-child {
            border-bottom: none;
        }

        .records-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .records-table th,
        .records-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .records-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .hidden {
            display: none;
        }

        .user-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
        }

        .welcome-text {
            font-size: 1.2em;
            color: #333;
        }

        .logout-btn {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
        }

        .search-box {
            display: flex;
            margin-bottom: 20px;
        }

        .search-box input {
            flex: 1;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 10px 0 0 10px;
            font-size: 16px;
        }

        .search-box button {
            padding: 10px 20px;
            border: none;
            border-radius: 0 10px 10px 0;
            cursor: pointer;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            transition: background 0.3s ease;
        }

        .search-box button:hover {
            background: linear-gradient(135deg, #00f2fe 0%, #4facfe 100%);
        }

        .export-options {
            display: flex;
            gap: 10px;
        }

        .export-options button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            transition: background 0.3s ease;
        }

        .export-options button:hover {
            background: linear-gradient(135deg, #00f2fe 0%, #4facfe 100%);
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

         /* æ–°å¢ï¼šäºŒçº§æŒ‰é’®ç»„æ ·å¼ */
        .sub-nav {
            display: flex;
            margin-top: 20px;
            border-bottom: 2px solid #e9ecef;
        }
        .sub-nav button {
            flex: 1;
            padding: 10px 0;
            background: transparent;
            border: none;
            font-size: 16px;
            color: #666;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .sub-nav button.active {
            color: #4facfe;
            border-bottom: 3px solid #4facfe;
            font-weight: 600;
        }
        .sub-tab-content {
            display: none;
            margin-top: 20px;
        }
        .sub-tab-content.active {
            display: block;
        }
        /* æ–°å¢ï¼šè¡¨æ ¼æ ·å¼ï¼ˆå‚è€ƒåŸæœ‰ records-tableï¼‰ */
        .admin-table {
            width: 100%;
            border-collapse: collapse;
        }
        .admin-table th,
        .admin-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }
        .admin-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
        }

        .pagination button {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            margin: 0 5px;
            transition: background 0.3s ease;
        }

        .pagination button:hover {
            background: linear-gradient(135deg, #00f2fe 0%, #4facfe 100%);
        }

        .pagination span {
            font-size: 16px;
            color: #333;
            margin: 0 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“ æ ¡å›­å¡ç®¡ç†ç³»ç»Ÿ</h1>
            <p>Campus Card Management System</p>
        </div>

        <!-- ç™»å½•é¡µé¢ -->
        <div id="login-section" class="section active">
            <div class="main-content">
                <div class="card" style="max-width: 400px; margin: 0 auto;">
                    <h2 style="text-align: center; margin-bottom: 30px; color: #333;">ç”¨æˆ·ç™»å½•</h2>
                    
                    <div id="login-alert" class="alert hidden"></div>
                    
                    <form id="login-form">
                        <div class="form-group">
                            <label for="username">ç”¨æˆ·åæˆ–å¡å·</label>
                            <input type="text" id="username" name="username" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="password">å¯†ç </label>
                            <input type="password" id="password" name="password" required>
                        </div>
                        
                        <button type="submit" class="btn" style="width: 100%;">ç™»å½•</button>
                    </form>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <a href="#" onclick="showRegisterForm()" style="color: #4facfe;">è¿˜æ²¡æœ‰è´¦å·ï¼Ÿç‚¹å‡»æ³¨å†Œ</a>
                    </div>
                    
                    <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #e9ecef;">
                        <h4 style="color: #666;">æµ‹è¯•è´¦å·</h4>
                        <p style="color: #888; margin: 10px 0;">ç®¡ç†å‘˜ï¼šadmin / admin123</p>
                        <p style="color: #888;">æ™®é€šç”¨æˆ·ï¼šzhangsan / 123456</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ³¨å†Œé¡µé¢ -->
        <div id="register-section" class="section">
            <div class="main-content">
                <div class="card" style="max-width: 400px; margin: 0 auto;">
                    <h2 style="text-align: center; margin-bottom: 30px; color: #333;">ç”¨æˆ·æ³¨å†Œ</h2>
                    
                    <div id="register-alert" class="alert hidden"></div>
                    
                    <form id="register-form">
                        <div class="form-group">
                            <label for="reg-username">ç”¨æˆ·å</label>
                            <input type="text" id="reg-username" name="username" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="reg-password">å¯†ç </label>
                            <input type="password" id="reg-password" name="password" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="reg-student-id">å­¦å·</label>
                            <input type="text" id="reg-student-id" name="student_id" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="reg-name">å§“å</label>
                            <input type="text" id="reg-name" name="name" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="reg-department">é™¢ç³»</label>
                            <input type="text" id="reg-department" name="department" required>
                        </div>
                        
                        <button type="submit" class="btn" style="width: 100%;">æ³¨å†Œ</button>
                        <button type="button" class="btn" style="width: 100%; margin-top: 10px; background: #ccc;" onclick="showLoginForm()">è¿”å›ç™»å½•</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- ç”¨æˆ·ä¸»é¡µé¢ -->
        <div id="main-section" class="section">
            <div class="main-content">
                <div class="user-info">
                    <div>
                        <span class="welcome-text">æ¬¢è¿å›æ¥ï¼Œ<span id="user-name"></span>ï¼</span>
                        <span style="margin-left: 20px; color: #666;">å¡å·ï¼š<span id="user-card"></span></span>
                    </div>
                    <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
                </div>

                <div class="nav-tabs">
                    <button class="nav-tab active" onclick="showTab('profile')">ä¸ªäººä¿¡æ¯</button>
                    <button class="nav-tab" onclick="showTab('records')">æ¶ˆè´¹è®°å½•</button>
                    <button class="nav-tab" onclick="showTab('recharge')">åœ¨çº¿å……å€¼</button>
                    <button class="nav-tab" onclick="showTab('admin')">ç³»ç»Ÿç®¡ç†</button>
                </div>

                <!-- ä¸ªäººä¿¡æ¯ -->
                <div id="profile-tab" class="tab-content">
                    <div class="info-grid">
                        <div class="card balance-card">
                            <h3>å½“å‰ä½™é¢</h3>
                            <div class="balance-amount">Â¥<span id="user-balance">0.00</span></div>
                            <p>Campus Card Balance</p>
                        </div>
                        
                        <div class="card">
                            <h3 style="margin-bottom: 20px;">åŸºæœ¬ä¿¡æ¯</h3>
                            <div id="user-details"></div>
                            <button class="btn" onclick="showEditProfileForm()" style="margin-top: 20px;">ä¿®æ”¹ä¸ªäººä¿¡æ¯</button>
                        </div>
                    </div>
                    
                    <div class="card" style="margin-top: 20px;">
                        <h3 style="margin-bottom: 20px;">å……å€¼è®°å½•</h3>
                        <div id="recharge-history">
                            <p style="text-align: center; color: #666;">åŠ è½½ä¸­...</p>
                        </div>
                    </div>
                </div>

                <!-- æ¶ˆè´¹è®°å½• -->
                <div id="records-tab" class="tab-content hidden">
                    <div class="card">
                        <h3 style="margin-bottom: 20px;">æ¶ˆè´¹è®°å½•</h3>
                        <div id="records-content">
                            <p style="text-align: center; color: #666;">åŠ è½½ä¸­...</p>
                        </div>
                    </div>
                </div>

                <!-- åœ¨çº¿å……å€¼ -->
                <div id="recharge-tab" class="tab-content hidden">
                    <div class="card">
                        <h3 style="margin-bottom: 20px;">åœ¨çº¿å……å€¼</h3>
                        <div id="recharge-alert" class="alert hidden"></div>
                        
                        <form id="recharge-form">
                            <div class="form-group">
                                <label for="target-card">ç›®æ ‡å¡å·</label>
                                <input type="text" id="target-card" name="target_card" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="target-password">ç›®æ ‡å¡å¯†ç </label>
                                <input type="password" id="target-password" name="target_password" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="amount">å……å€¼é‡‘é¢</label>
                                <input type="number" id="amount" name="amount" min="1" step="0.01" required>
                            </div>
                            
                            <button type="submit" class="btn">ç¡®è®¤å……å€¼</button>
                        </form>
                    </div>
                </div>

                <!-- ç³»ç»Ÿç®¡ç† -->
                <div id="admin-tab-content" class="tab-content hidden">
                        <div class="card">
                            <h3>ç”¨æˆ·ç®¡ç†</h3>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                            <button onclick="showCreateUserModal()" class="btn">åˆ›å»ºæ–°ç”¨æˆ·</button>
                            <div class="search-box" style="display: flex; gap: 10px; width: 70%;">
                                <div style="flex: 1;">
                                <input type="text" id="user-search" placeholder="æœç´¢ç”¨æˆ·å/å¡å·/å­¦å·">
                            </div>
                                <div style="flex: 1;">
                                    <input type="text" id="department-search" placeholder="æœç´¢å­¦é™¢" style="width: 100%; padding: 10px; border: 2px solid #e9ecef; border-radius: 10px; font-size: 16px;">
                                </div>
                                <button onclick="searchUsers()" class="btn">æœç´¢</button>
                            </div>
                        </div>
                        <div id="users-table"></div>

                        <!-- æ–°å¢ï¼šæ“ä½œæ—¥å¿—éƒ¨åˆ† -->
                        <div style="margin-top: 40px;">
                            <h3>æ“ä½œæ—¥å¿—</h3>
                            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                                <div class="search-box" style="flex: 2;">
                                    <input type="text" id="log-search" list="action-types" placeholder="æœç´¢æ“ä½œå†…å®¹">
                                    <datalist id="action-types">
                                        <option value="ç”¨æˆ·ç™»å½•">
                                        <option value="åˆ›å»ºç”¨æˆ·">
                                        <option value="åˆ é™¤ç”¨æˆ·">
                                        <option value="ä¿®æ”¹ä¸ªäººä¿¡æ¯">
                                        <option value="ä¿®æ”¹å¯†ç ">
                                        <option value="åœ¨çº¿å……å€¼">
                                        <option value="å†»ç»“ç”¨æˆ·">
                                        <option value="è§£å†»ç”¨æˆ·">
                                    </datalist>
                                    <button onclick="searchLogs()" class="btn">æœç´¢æ—¥å¿—</button>
                                </div>
                                <div style="flex: 1;">
                                    <select id="operator-filter" style="width: 100%; padding: 10px; border: 2px solid #e9ecef; border-radius: 10px; font-size: 16px;">
                                        <option value="">æ‰€æœ‰æ“ä½œäºº</option>
                                    </select>
                                </div>
                            </div>
                            <div id="logs-table"></div>
                        </div>
                            </div>
                </div>
            </div>
        </div>

        <!-- ä¿®æ”¹ä¸ªäººä¿¡æ¯æ¨¡æ€æ¡† -->
        <div id="edit-profile-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <h3>ä¿®æ”¹ä¸ªäººä¿¡æ¯</h3>
                <div id="edit-profile-alert" class="alert hidden"></div>
                <form id="edit-profile-form">
                    <div class="form-group">
                        <label for="edit-name">å§“å</label>
                        <input type="text" id="edit-name" name="name">
                    </div>
                    <div class="form-group">
                        <label for="edit-department">é™¢ç³»</label>
                        <input type="text" id="edit-department" name="department">
                    </div>
                    <div class="form-group">
                        <label for="edit-phone">æ‰‹æœºå·ç </label>
                        <input type="tel" id="edit-phone" name="phone">
                    </div>
                    <div class="form-group">
                        <label for="edit-email">é‚®ç®±</label>
                        <input type="email" id="edit-email" name="email">
                    </div>
                    <div class="modal-buttons">
                        <button type="submit" class="btn">ä¿å­˜</button>
                        <button type="button" class="btn" style="background: #ccc;" onclick="hideEditProfileForm()">å–æ¶ˆ</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- åˆ›å»ºç”¨æˆ·æ¨¡æ€æ¡† -->
        <div id="create-user-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <h3>åˆ›å»ºæ–°ç”¨æˆ·</h3>
                <div id="create-user-alert" class="alert hidden"></div>
                <form id="create-user-form">
                    <div class="form-group">
                        <label for="new-username">ç”¨æˆ·å</label>
                        <input type="text" id="new-username" name="username" required>
                    </div>
                    <div class="form-group">
                        <label for="new-password">å¯†ç </label>
                        <input type="password" id="new-password" name="password" required>
                    </div>
                    <div class="form-group">
                        <label for="new-name">å§“å</label>
                        <input type="text" id="new-name" name="name" required>
                    </div>
                    <div class="form-group">
                        <label for="new-student-id">å­¦å·</label>
                        <input type="text" id="new-student-id" name="student_id" required>
                    </div>
                    <div class="form-group">
                        <label for="new-department">é™¢ç³»</label>
                        <input type="text" id="new-department" name="department" required style="width: 100%; padding: 12px 15px; border: 2px solid #e9ecef; border-radius: 10px; font-size: 16px;">
                    </div>
                    <div class="modal-buttons">
                        <button type="submit" class="btn">åˆ›å»º</button>
                        <button type="button" class="btn" style="background: #ccc;" onclick="hideCreateUserModal()">å–æ¶ˆ</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- ç¡®è®¤åˆ é™¤ç”¨æˆ·æ¨¡æ€æ¡† -->
        <div id="delete-user-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <h3>ç¡®è®¤åˆ é™¤ç”¨æˆ·</h3>
                <p>æ‚¨ç¡®å®šè¦åˆ é™¤ç”¨æˆ· <span id="delete-user-name"></span> å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚</p>
                <div id="delete-user-alert" class="alert hidden"></div>
                <div class="modal-buttons">
                    <button onclick="confirmDeleteUser()" class="btn btn-danger">ç¡®è®¤åˆ é™¤</button>
                    <button onclick="hideDeleteUserModal()" class="btn" style="background: #ccc;">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://127.0.0.1:3000/api';
        let currentUser = JSON.parse(localStorage.getItem('currentUser')) || null;
        let authToken = localStorage.getItem('authToken') || null;
        let userToDelete = null;

        // é¡µé¢åŠ è½½å®Œæˆåæ£€æŸ¥ç™»å½•çŠ¶æ€
        document.addEventListener('DOMContentLoaded', () => {
            if (currentUser && authToken) {
                showMainSection();
            }
        });

        // ç™»å½•åŠŸèƒ½
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // å…ˆé‡ç½®æ‰€æœ‰æ˜¾ç¤ºçŠ¶æ€
            document.querySelector('.balance-card').style.display = 'block';
            document.querySelector('#recharge-history').parentElement.style.display = 'block';
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            try {
                const response = await fetch(`${API_BASE}/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    authToken = result.token;
                    currentUser = result.user;
                    // ä¿å­˜ç™»å½•çŠ¶æ€åˆ° localStorage
                    localStorage.setItem('authToken', authToken);
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    showAlert('login-alert', 'ç™»å½•æˆåŠŸï¼', 'success');
                    
                    setTimeout(() => {
                        showMainSection();
                    }, 1000);
                } else {
                    showAlert('login-alert', result.error || 'ç™»å½•å¤±è´¥', 'error');
                }
            } catch (error) {
                showAlert('login-alert', 'ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦å¯åŠ¨', 'error');
            }
        });

        // æ˜¾ç¤ºä¸»ç•Œé¢
        function showMainSection() {
            document.getElementById('login-section').classList.remove('active');
            document.getElementById('main-section').classList.add('active');
            
            // æ›´æ–°ç”¨æˆ·ä¿¡æ¯
            document.getElementById('user-name').textContent = currentUser.name || currentUser.username;
            document.getElementById('user-card').textContent = currentUser.card_number || currentUser.id;
            
            // å…ˆæ˜¾ç¤ºæ‰€æœ‰å…ƒç´ ï¼Œåé¢å†æ ¹æ®è§’è‰²éšè—
            document.querySelector('.balance-card').style.display = 'block';
            document.querySelector('#recharge-history').parentElement.style.display = 'block';
            
            // å…ˆéšè—æ‰€æœ‰æ ‡ç­¾é¡µå†…å®¹
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => content.classList.add('hidden'));
            
            // é‡ç½®æ‰€æœ‰å¯¼èˆªæ ‡ç­¾çŠ¶æ€
            const navTabs = document.querySelectorAll('.nav-tab');
            navTabs.forEach(tab => {
                tab.classList.remove('active');
                tab.style.display = 'block';  // å…ˆæ˜¾ç¤ºæ‰€æœ‰æ ‡ç­¾
            });
            
            // æ ¹æ®ç”¨æˆ·è§’è‰²æ§åˆ¶æ˜¾ç¤ºå†…å®¹
            const isAdmin = currentUser.role === 'admin';
            
            if (isAdmin) {
                // ç®¡ç†å‘˜éšè—ä½™é¢å’Œå……å€¼è®°å½•
                document.querySelector('.balance-card').style.display = 'none';
                document.querySelector('#recharge-history').parentElement.style.display = 'none';
                // ç®¡ç†å‘˜éšè—æ¶ˆè´¹è®°å½•å’Œåœ¨çº¿å……å€¼æ ‡ç­¾
                navTabs.forEach(tab => {
                    if (tab.textContent === 'æ¶ˆè´¹è®°å½•' || tab.textContent === 'åœ¨çº¿å……å€¼') {
                        tab.style.display = 'none';
                    }
                });
                // ç®¡ç†å‘˜é»˜è®¤æ˜¾ç¤ºä¸ªäººä¿¡æ¯æ ‡ç­¾é¡µ [ä¿®æ”¹æ­¤å¤„]
                document.querySelector('[onclick="showTab(\'profile\')"]').classList.add('active');
                document.getElementById('profile-tab').classList.remove('hidden');
            } else {
                // æ™®é€šç”¨æˆ·éšè—ç³»ç»Ÿç®¡ç†æ ‡ç­¾
                navTabs.forEach(tab => {
                    if (tab.textContent === 'ç³»ç»Ÿç®¡ç†') {
                        tab.style.display = 'none';
                    }
                });
                // æ™®é€šç”¨æˆ·é»˜è®¤æ˜¾ç¤ºä¸ªäººä¿¡æ¯æ ‡ç­¾é¡µ
                document.querySelector('[onclick="showTab(\'profile\')"]').classList.add('active');
                document.getElementById('profile-tab').classList.remove('hidden');
            }
            
            // åŠ è½½ç”¨æˆ·è¯¦ç»†ä¿¡æ¯
            loadUserProfile();
        }

        // åŠ è½½ç”¨æˆ·ä¿¡æ¯
        async function loadUserProfile() {
            try {
                const response = await fetch(`${API_BASE}/profile`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    const user = await response.json();
                    currentUser = { ...currentUser, ...user }; // æ›´æ–°å½“å‰ç”¨æˆ·ä¿¡æ¯
                    document.getElementById('user-balance').textContent = user.balance || '0.00';
                    
                    const detailsHtml = `
                        <div class="info-item">
                            <span><strong>å§“å</strong></span>
                            <span>${user.name || 'æœªè®¾ç½®'}</span>
                        </div>
                        <div class="info-item">
                            <span><strong>å­¦å·</strong></span>
                            <span>${user.student_id || 'æœªè®¾ç½®'}</span>
                        </div>
                        <div class="info-item">
                            <span><strong>é™¢ç³»</strong></span>
                            <span>${user.department || 'æœªè®¾ç½®'}</span>
                        </div>
                        <div class="info-item">
                            <span><strong>æ‰‹æœº</strong></span>
                            <span>${user.phone || 'æœªè®¾ç½®'}</span>
                        </div>
                        <div class="info-item">
                            <span><strong>é‚®ç®±</strong></span>
                            <span>${user.email || 'æœªè®¾ç½®'}</span>
                        </div>
                    `;
                    document.getElementById('user-details').innerHTML = detailsHtml;
                    
                    // ç«‹å³åŠ è½½å……å€¼è®°å½•
                    await loadRechargeHistory();
                }
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
            }
        }

        // åŠ è½½æ¶ˆè´¹è®°å½•
        async function loadRecords() {
            try {
                const response = await fetch(`${API_BASE}/consumption-records`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const records = data.records || [];
                    
                    if (records.length === 0) {
                        document.getElementById('records-content').innerHTML = '<p style="text-align: center; color: #666;">æš‚æ— æ¶ˆè´¹è®°å½•</p>';
                        return;
                    }
                    
                    const tableHtml = `
                        <table class="records-table">
                            <thead>
                                <tr>
                                    <th>æ—¶é—´</th>
                                    <th>å•†æˆ·</th>
                                    <th>æ¶ˆè´¹è¯´æ˜</th>
                                    <th>é‡‘é¢</th>
                                    <th>ä½™é¢</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${records.map(record => `
                                    <tr>
                                        <td>${new Date(record.created_at).toLocaleString()}</td>
                                        <td>${record.merchant}</td>
                                        <td>${record.description}</td>
                                        <td style="color: #ff6b6b;">-Â¥${record.amount}</td>
                                        <td>Â¥${record.balance_after}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                    document.getElementById('records-content').innerHTML = tableHtml;
                }
            } catch (error) {
                document.getElementById('records-content').innerHTML = '<p style="text-align: center; color: #ff6b6b;">åŠ è½½å¤±è´¥</p>';
            }
        }

        // å……å€¼åŠŸèƒ½
        document.getElementById('recharge-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const rechargeData = {
                target_card: formData.get('target_card'),
                target_password: formData.get('target_password'),
                amount: parseFloat(formData.get('amount'))
            };
            
            try {
                const response = await fetch(`${API_BASE}/recharge`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(rechargeData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showAlert('recharge-alert', `æˆåŠŸå‘${result.to_user}è½¬è´¦ Â¥${rechargeData.amount}`, 'success');
                    e.target.reset();
                    
                    // æ›´æ–°æ˜¾ç¤ºçš„ä½™é¢å’Œé‡æ–°åŠ è½½å……å€¼è®°å½•
                    const balanceElement = document.getElementById('user-balance');
                    balanceElement.textContent = result.new_balance.toFixed(2);
                    await loadUserProfile(); // é‡æ–°åŠ è½½æ‰€æœ‰ç”¨æˆ·ä¿¡æ¯å’Œå……å€¼è®°å½•
                } else {
                    showAlert('recharge-alert', result.error || 'å……å€¼å¤±è´¥', 'error');
                }
            } catch (error) {
                showAlert('recharge-alert', 'ç½‘ç»œé”™è¯¯', 'error');
            }
        });

        // æ ‡ç­¾é¡µåˆ‡æ¢
        function showTab(tabName) {
            // æ£€æŸ¥æ˜¯å¦æ˜¯ç®¡ç†å‘˜
            if (currentUser.role === 'admin') {
                if (tabName === 'records' || tabName === 'recharge') {
                    return; // ç®¡ç†å‘˜ä¸å…è®¸è®¿é—®è¿™äº›æ ‡ç­¾é¡µ
                }
            }

            // æ›´æ–°å¯¼èˆªæ ‡ç­¾
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            // éšè—æ‰€æœ‰æ ‡ç­¾é¡µå†…å®¹
            document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
            
            // æ˜¾ç¤ºæŒ‡å®šæ ‡ç­¾é¡µ
            const targetTab = document.getElementById(`${tabName}-tab`) || document.getElementById(`${tabName}-tab-content`);
            if (targetTab) {
                targetTab.classList.remove('hidden');
            }
            
            // åŠ è½½ç›¸åº”æ•°æ®
            if (tabName === 'records') {
                loadRecords();
            } else if (tabName === 'admin') {
                loadAdminDashboard();
            } else if (tabName === 'profile') {
                // åˆ‡æ¢åˆ°ä¸ªäººä¿¡æ¯æ ‡ç­¾é¡µæ—¶é‡æ–°åŠ è½½ç”¨æˆ·ä¿¡æ¯
                loadUserProfile();
            }
        }

        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        function showAlert(elementId, message, type) {
            const alertElement = document.getElementById(elementId);
            alertElement.className = `alert alert-${type}`;
            alertElement.textContent = message;
            alertElement.classList.remove('hidden');
            
            // 3ç§’åè‡ªåŠ¨éšè—æç¤ºä¿¡æ¯
            setTimeout(() => {
                alertElement.classList.add('hidden');
                alertElement.textContent = '';
            }, 3000);
        }

        // æ¸…é™¤æ‰€æœ‰æç¤ºä¿¡æ¯
        function clearAllAlerts() {
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(alert => {
                alert.classList.add('hidden');
                alert.textContent = '';
            });
        }

        // é€€å‡ºç™»å½•
        function logout() {
            currentUser = null;
            authToken = null;
            // æ¸…é™¤æœ¬åœ°å­˜å‚¨çš„ç™»å½•çŠ¶æ€
            localStorage.removeItem('currentUser');
            localStorage.removeItem('authToken');
            
            // é‡ç½®æ˜¾ç¤ºçŠ¶æ€
            document.querySelector('.balance-card').style.display = 'block';
            document.querySelector('#recharge-history').parentElement.style.display = 'block';
            const navTabs = document.querySelectorAll('.nav-tab');
            navTabs.forEach(tab => {
                tab.style.display = 'block';
            });
            
            // é‡ç½®æ‰€æœ‰æ˜¾ç¤ºçŠ¶æ€
            document.getElementById('main-section').classList.remove('active');
            document.getElementById('login-section').classList.add('active');
            
            // æ¸…ç†è¡¨æ ¼å†…å®¹
            document.getElementById('users-table').innerHTML = '';
            document.getElementById('logs-table').innerHTML = '';
            
            // é‡ç½®è¡¨å•
            document.getElementById('login-form').reset();
            
            // æ¸…é™¤æ‰€æœ‰æç¤ºä¿¡æ¯
            clearAllAlerts();
        }

        // æ˜¾ç¤ºæ³¨å†Œè¡¨å•
        function showRegisterForm() {
            document.getElementById('login-section').classList.remove('active');
            document.getElementById('register-section').classList.add('active');
            clearAllAlerts(); // åˆ‡æ¢è¡¨å•æ—¶æ¸…é™¤æç¤ºä¿¡æ¯
        }

        // è¿”å›ç™»å½•è¡¨å•
        function showLoginForm() {
            document.getElementById('register-section').classList.remove('active');
            document.getElementById('login-section').classList.add('active');
            clearAllAlerts(); // åˆ‡æ¢è¡¨å•æ—¶æ¸…é™¤æç¤ºä¿¡æ¯
        }

        // å¤„ç†æ³¨å†Œè¡¨å•æäº¤
        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const registerData = Object.fromEntries(formData.entries());
            
            try {
                const response = await fetch(`${API_BASE}/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(registerData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showAlert('register-alert', 'æ³¨å†ŒæˆåŠŸï¼è¯·ç™»å½•', 'success');
                    setTimeout(() => {
                        showLoginForm();
                        e.target.reset();
                    }, 1500);
                } else {
                    showAlert('register-alert', result.error || 'æ³¨å†Œå¤±è´¥', 'error');
                }
            } catch (error) {
                showAlert('register-alert', 'ç½‘ç»œé”™è¯¯', 'error');
            }
        });

        // åŠ è½½å……å€¼è®°å½•
        async function loadRechargeHistory() {
            try {
                const response = await fetch(`${API_BASE}/recharge-records?limit=50`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const records = data.records || [];
                    
                    if (records.length === 0) {
                        document.getElementById('recharge-history').innerHTML = 
                            '<p style="text-align: center; color: #666;">æš‚æ— å……å€¼è®°å½•</p>';
                        return;
                    }
                    
                    const tableHtml = `
                        <table class="records-table">
                            <thead>
                                <tr>
                                    <th>æ—¶é—´</th>
                                    <th>ç±»å‹</th>
                                    <th>é‡‘é¢</th>
                                    <th>çŠ¶æ€</th>
                                    <th>å¤‡æ³¨</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${records.map(record => `
                                    <tr>
                                        <td>${new Date(record.created_at).toLocaleString()}</td>
                                        <td>${record.method === 'transfer' ? 'è½¬è´¦' : 'åœ¨çº¿å……å€¼'}</td>
                                        <td style="color: #4facfe;">+Â¥${record.amount}</td>
                                        <td>${record.status === 'completed' ? 'æˆåŠŸ' : 'å¤„ç†ä¸­'}</td>
                                        <td>${record.remark || '-'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                    document.getElementById('recharge-history').innerHTML = tableHtml;
                }
            } catch (error) {
                console.error('åŠ è½½å……å€¼è®°å½•å¤±è´¥:', error);
                document.getElementById('recharge-history').innerHTML = 
                    '<p style="text-align: center; color: #ff6b6b;">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</p>';
            }
        }

        // ä¿®æ”¹åŠ è½½ç®¡ç†å‘˜ä»ªè¡¨ç›˜å‡½æ•°
        async function loadAdminDashboard() {
            try {
                const response = await fetch(`${API_BASE}/admin/users`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    // é¦–æ¬¡åŠ è½½æ—¶è°ƒç”¨ loadUsers å’Œ loadLogs
                    await Promise.all([
                        loadUsers(1),  // åŠ è½½ç¬¬ä¸€é¡µç”¨æˆ·æ•°æ®
                        loadLogs(1),    // åŠ è½½ç¬¬ä¸€é¡µæ—¥å¿—æ•°æ®
                        loadOperators() // åŠ è½½æ“ä½œäººåˆ—è¡¨
                    ]);
                } else if (response.status === 403) {
                    document.getElementById('users-table').innerHTML = 
                        '<p style="text-align: center; color: #ff6b6b;">æ‚¨æ²¡æœ‰æƒé™è®¿é—®æ­¤åŠŸèƒ½</p>';
                }
            } catch (error) {
                console.error('åŠ è½½ç®¡ç†å‘˜ä»ªè¡¨ç›˜å¤±è´¥:', error);
                document.getElementById('users-table').innerHTML = 
                    '<p style="text-align: center; color: #ff6b6b;">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</p>';
            }
        }

        let currentPage = 1; // ç”¨æˆ·åˆ—è¡¨å½“å‰é¡µ
        let currentLogPage = 1; // æ—¥å¿—åˆ—è¡¨å½“å‰é¡µ
        let totalPages = 1; // ç”¨æˆ·åˆ—è¡¨æ€»é¡µæ•°
        let totalLogPages = 1; // æ—¥å¿—åˆ—è¡¨æ€»é¡µæ•°

        // åŠ è½½ç”¨æˆ·åˆ—è¡¨
        async function loadUsers(page = 1) {
            try {
                const response = await fetch(`${API_BASE}/admin/users?page=${page}&limit=10`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    currentPage = page;
                    totalPages = data.pages;
                    const users = data.users || [];
                    
                    if (users.length === 0) {
                        document.getElementById('users-table').innerHTML = 
                            '<p style="text-align: center; color: #666;">æš‚æ— ç”¨æˆ·æ•°æ®</p>';
                        return;
                    }
                    
                    const tableHtml = `
                        <table class="records-table">
                            <thead>
                                <tr>
                                    <th>ç”¨æˆ·å</th>
                                    <th>å§“å</th>
                                    <th>å­¦å·</th>
                                    <th>é™¢ç³»</th>
                                    <th>å¡å·</th>
                                    <th>ä½™é¢</th>
                                    <th>çŠ¶æ€</th>
                                    <th>æ³¨å†Œæ—¶é—´</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${users.map(user => `
                                    <tr data-user-id="${user.id}">
                                        <td>${user.username}</td>
                                        <td>${user.name || '-'}</td>
                                        <td>${user.student_id || '-'}</td>
                                        <td>${user.department || '-'}</td>
                                        <td>${user.card_number || '-'}</td>
                                        <td>Â¥${user.balance || '0.00'}</td>
                                        <td>${user.status === 'active' ? 'æ­£å¸¸' : 'å·²å†»ç»“'}</td>
                                        <td>${new Date(user.created_at).toLocaleString()}</td>
                                        <td>
                                            <div style="display: flex; gap: 5px;">
                                                <button onclick='showDeleteUserModal(${JSON.stringify(user).replace(/'/g, "\\'")})' class="btn btn-danger" style="padding: 5px 10px; font-size: 14px;">åˆ é™¤</button>
                                                <button onclick='toggleUserStatus(${JSON.stringify(user).replace(/'/g, "\\'")})' class="btn ${user.status === 'active' ? 'btn-danger' : 'btn-success'}" style="padding: 5px 10px; font-size: 14px;">
                                                    ${user.status === 'active' ? 'å†»ç»“' : 'è§£å†»'}
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        <div class="pagination">
                            <button onclick="loadUsers(${page - 1})" 
                                    ${page <= 1 ? 'disabled' : ''}>ä¸Šä¸€é¡µ</button>
                            <span>ç¬¬ ${page} é¡µ / å…± ${data.pages} é¡µ</span>
                            <button onclick="loadUsers(${page + 1})"
                                    ${page >= data.pages ? 'disabled' : ''}>ä¸‹ä¸€é¡µ</button>
                        </div>
                    `;
                    document.getElementById('users-table').innerHTML = tableHtml;
                }
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥:', error);
                document.getElementById('users-table').innerHTML = 
                    '<p style="text-align: center; color: #ff6b6b;">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</p>';
            }
        }

        // åŠ è½½æ“ä½œæ—¥å¿—
        async function loadLogs(page = 1) {
            try {
                const response = await fetch(`${API_BASE}/admin/logs?page=${page}&limit=10`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    currentLogPage = page;
                    totalLogPages = data.pages;
                    const logs = data.logs || [];
                    
                    if (logs.length === 0) {
                        document.getElementById('logs-table').innerHTML = 
                            '<p style="text-align: center; color: #666;">æš‚æ— æ“ä½œæ—¥å¿—</p>';
                        return;
                    }
                    
                    const tableHtml = `
                        <table class="records-table">
                            <thead>
                                <tr>
                                    <th>æ“ä½œæ—¶é—´</th>
                                    <th>æ“ä½œç±»å‹</th>
                                    <th>æ“ä½œå†…å®¹</th>
                                    <th>æ“ä½œäºº</th>
                                    <th>IPåœ°å€</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${logs.map(log => `
                                    <tr>
                                        <td>${new Date(log.created_at).toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' })}</td>
                                        <td>${log.action_type}</td>
                                        <td>${log.action_content}</td>
                                        <td>${log.operator_card || '-'}</td>
                                        <td>${log.ip_address}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        <div class="pagination">
                            <button onclick="loadLogs(${page - 1})"
                                    ${page <= 1 ? 'disabled' : ''}>ä¸Šä¸€é¡µ</button>
                            <span>ç¬¬ ${page} é¡µ / å…± ${data.pages} é¡µ</span>
                            <button onclick="loadLogs(${page + 1})"
                                    ${page >= data.pages ? 'disabled' : ''}>ä¸‹ä¸€é¡µ</button>
                        </div>
                    `;
                    document.getElementById('logs-table').innerHTML = tableHtml;
                }
            } catch (error) {
                console.error('åŠ è½½æ“ä½œæ—¥å¿—å¤±è´¥:', error);
                document.getElementById('logs-table').innerHTML = 
                    '<p style="text-align: center; color: #ff6b6b;">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</p>';
            }
        }

        // æœç´¢ç”¨æˆ·
        async function searchUsers(page = 1) {
            const searchTerm = document.getElementById('user-search').value.trim();
            const department = document.getElementById('department-search').value;
            
            try {
                let url = `${API_BASE}/admin/users?page=${page}&limit=10`;
                if (searchTerm) {
                    url += `&search=${encodeURIComponent(searchTerm)}`;
                }
                if (department) {
                    url += `&department=${encodeURIComponent(department)}`;
                }
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    currentPage = page;
                    totalPages = data.pages;
                    const users = data.users || [];
                    
                    if (users.length === 0) {
                        document.getElementById('users-table').innerHTML = 
                            '<p style="text-align: center; color: #666;">æœªæ‰¾åˆ°åŒ¹é…çš„ç”¨æˆ·</p>';
                        return;
                    }
                    
                    const tableHtml = `
                        <table class="records-table">
                            <thead>
                                <tr>
                                    <th>ç”¨æˆ·å</th>
                                    <th>å§“å</th>
                                    <th>å­¦å·</th>
                                    <th>é™¢ç³»</th>
                                    <th>å¡å·</th>
                                    <th>ä½™é¢</th>
                                    <th>çŠ¶æ€</th>
                                    <th>æ³¨å†Œæ—¶é—´</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${users.map(user => `
                                    <tr data-user-id="${user.id}">
                                        <td>${user.username}</td>
                                        <td>${user.name || '-'}</td>
                                        <td>${user.student_id || '-'}</td>
                                        <td>${user.department || '-'}</td>
                                        <td>${user.card_number || '-'}</td>
                                        <td>Â¥${user.balance || '0.00'}</td>
                                        <td>${user.status === 'active' ? 'æ­£å¸¸' : 'å·²å†»ç»“'}</td>
                                        <td>${new Date(user.created_at).toLocaleString()}</td>
                                        <td>
                                            <div style="display: flex; gap: 5px;">
                                                <button onclick='showDeleteUserModal(${JSON.stringify(user).replace(/'/g, "\\'")})' class="btn btn-danger" style="padding: 5px 10px; font-size: 14px;">åˆ é™¤</button>
                                                <button onclick='toggleUserStatus(${JSON.stringify(user).replace(/'/g, "\\'")})' class="btn ${user.status === 'active' ? 'btn-danger' : 'btn-success'}" style="padding: 5px 10px; font-size: 14px;">
                                                    ${user.status === 'active' ? 'å†»ç»“' : 'è§£å†»'}
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        <div class="pagination">
                            <button onclick="searchUsers(${page - 1})" 
                                    ${page <= 1 ? 'disabled' : ''}>ä¸Šä¸€é¡µ</button>
                            <span>ç¬¬ ${page} é¡µ / å…± ${data.pages} é¡µ</span>
                            <button onclick="searchUsers(${page + 1})"
                                    ${page >= data.pages ? 'disabled' : ''}>ä¸‹ä¸€é¡µ</button>
                        </div>
                    `;
                    document.getElementById('users-table').innerHTML = tableHtml;
                } else if (response.status === 403) {
                    document.getElementById('users-table').innerHTML = 
                        '<p style="text-align: center; color: #ff6b6b;">æ‚¨æ²¡æœ‰æƒé™è®¿é—®æ­¤åŠŸèƒ½</p>';
                }
            } catch (error) {
                console.error('æœç´¢ç”¨æˆ·å¤±è´¥:', error);
                document.getElementById('users-table').innerHTML = 
                    '<p style="text-align: center; color: #ff6b6b;">æœç´¢å¤±è´¥ï¼Œè¯·é‡è¯•</p>';
            }
        }

        // æœç´¢æ“ä½œæ—¥å¿—
        async function searchLogs(page = 1) {
            const searchTerm = document.getElementById('log-search').value.trim();
            const operatorCard = document.getElementById('operator-filter').value;
            
            try {
                let url = `${API_BASE}/admin/logs?page=${page}&limit=10`;
                if (searchTerm) {
                    url += `&search=${encodeURIComponent(searchTerm)}`;
                }
                if (operatorCard) {
                    url += `&operator=${encodeURIComponent(operatorCard)}`;
                }
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    currentLogPage = page;
                    totalLogPages = data.pages;
                    const logs = data.logs || [];
                    
                    if (logs.length === 0) {
                        document.getElementById('logs-table').innerHTML = 
                            '<p style="text-align: center; color: #666;">æœªæ‰¾åˆ°åŒ¹é…çš„æ“ä½œæ—¥å¿—</p>';
                        return;
                    }
                    
                    const tableHtml = `
                        <table class="records-table">
                            <thead>
                                <tr>
                                    <th>æ“ä½œæ—¶é—´</th>
                                    <th>æ“ä½œç±»å‹</th>
                                    <th>æ“ä½œå†…å®¹</th>
                                    <th>æ“ä½œäºº</th>
                                    <th>IPåœ°å€</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${logs.map(log => `
                                    <tr>
                                        <td>${new Date(log.created_at).toLocaleString()}</td>
                                        <td>${log.action_type}</td>
                                        <td>${log.action_content}</td>
                                        <td>${log.operator}</td>
                                        <td>${log.ip_address}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        <div class="pagination">
                            <button onclick="searchLogs(${page - 1})"
                                    ${page <= 1 ? 'disabled' : ''}>ä¸Šä¸€é¡µ</button>
                            <span>ç¬¬ ${page} é¡µ / å…± ${data.pages} é¡µ</span>
                            <button onclick="searchLogs(${page + 1})"
                                    ${page >= data.pages ? 'disabled' : ''}>ä¸‹ä¸€é¡µ</button>
                        </div>
                    `;
                    document.getElementById('logs-table').innerHTML = tableHtml;
                }
            } catch (error) {
                console.error('æœç´¢æ“ä½œæ—¥å¿—å¤±è´¥:', error);
                document.getElementById('logs-table').innerHTML = 
                    '<p style="text-align: center; color: #ff6b6b;">æœç´¢å¤±è´¥ï¼Œè¯·é‡è¯•</p>';
            }
        }

        // æ˜¾ç¤ºåˆ›å»ºç”¨æˆ·æ¨¡æ€æ¡†
        function showCreateUserModal() {
            const modal = document.getElementById('create-user-modal');
            modal.style.display = 'flex';
            document.getElementById('create-user-form').reset();
        }

        // éšè—åˆ›å»ºç”¨æˆ·æ¨¡æ€æ¡†
        function hideCreateUserModal() {
            const modal = document.getElementById('create-user-modal');
            modal.style.display = 'none';
        }

        // æ˜¾ç¤ºåˆ é™¤ç”¨æˆ·ç¡®è®¤æ¨¡æ€æ¡†
        function showDeleteUserModal(user) {
            userToDelete = user;
            const modal = document.getElementById('delete-user-modal');
            document.getElementById('delete-user-name').textContent = user.username;
            modal.style.display = 'flex';
        }

        // éšè—åˆ é™¤ç”¨æˆ·ç¡®è®¤æ¨¡æ€æ¡†
        function hideDeleteUserModal() {
            const modal = document.getElementById('delete-user-modal');
            modal.style.display = 'none';
            userToDelete = null;
        }

        // å¤„ç†åˆ›å»ºç”¨æˆ·è¡¨å•æäº¤
        document.getElementById('create-user-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const userData = Object.fromEntries(formData.entries());
            
            try {
                const response = await fetch(`${API_BASE}/admin/users`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(userData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showAlert('create-user-alert', 'ç”¨æˆ·åˆ›å»ºæˆåŠŸ', 'success');
                    // è®°å½•åˆ›å»ºç”¨æˆ·æ—¥å¿—
                    await recordLog('åˆ›å»ºç”¨æˆ·', `åˆ›å»ºç”¨æˆ·ï¼š${userData.username}`);
                    setTimeout(() => {
                        hideCreateUserModal();
                        loadUsers();
                        loadLogs(); // é‡æ–°åŠ è½½æ—¥å¿—
                    }, 1500);
                } else {
                    showAlert('create-user-alert', result.error || 'åˆ›å»ºç”¨æˆ·å¤±è´¥', 'error');
                }
            } catch (error) {
                showAlert('create-user-alert', 'ç½‘ç»œé”™è¯¯', 'error');
            }
        });

        // ç¡®è®¤åˆ é™¤ç”¨æˆ·
        async function confirmDeleteUser() {
            if (!userToDelete) return;
            
            try {
                const response = await fetch(`${API_BASE}/admin/users/${userToDelete.id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showAlert('delete-user-alert', 'ç”¨æˆ·åˆ é™¤æˆåŠŸ', 'success');
                    // è®°å½•åˆ é™¤ç”¨æˆ·æ—¥å¿—
                    await recordLog('åˆ é™¤ç”¨æˆ·', `åˆ é™¤ç”¨æˆ·ï¼š${userToDelete.username}`);
                    setTimeout(() => {
                        hideDeleteUserModal();
                        loadUsers();
                        loadLogs(); // é‡æ–°åŠ è½½æ—¥å¿—
                    }, 1500);
                } else {
                    showAlert('delete-user-alert', result.error || 'åˆ é™¤ç”¨æˆ·å¤±è´¥', 'error');
                }
            } catch (error) {
                showAlert('delete-user-alert', 'ç½‘ç»œé”™è¯¯', 'error');
            }
        }

        // è®°å½•æ“ä½œæ—¥å¿—
        async function recordLog(actionType, actionContent) {
            try {
                await fetch(`${API_BASE}/admin/logs`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        action_type: actionType,
                        action_content: actionContent,
                        operator_card: currentUser.card_number
                    })
                });
            } catch (error) {
                console.error('è®°å½•æ“ä½œæ—¥å¿—å¤±è´¥:', error);
            }
        }

        // åŠ è½½æ“ä½œäººåˆ—è¡¨
        async function loadOperators() {
            try {
                const response = await fetch(`${API_BASE}/admin/operators`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    const operators = await response.json();
                    const selectElement = document.getElementById('operator-filter');
                    
                    // æ¸…é™¤ç°æœ‰é€‰é¡¹ï¼Œåªä¿ç•™é»˜è®¤é€‰é¡¹
                    while (selectElement.options.length > 1) {
                        selectElement.remove(1);
                    }
                    
                    // ä½¿ç”¨ Set å»é‡
                    const uniqueOperators = Array.from(new Set(operators.map(op => 
                        JSON.stringify({card_number: op.card_number, name: op.name})
                    ))).map(str => JSON.parse(str));
                    
                    // æ·»åŠ æ–°é€‰é¡¹
                    uniqueOperators.forEach(op => {
                        const option = document.createElement('option');
                        option.value = op.card_number;
                        option.textContent = `${op.name} (${op.card_number})`;
                        selectElement.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('åŠ è½½æ“ä½œäººåˆ—è¡¨å¤±è´¥:', error);
            }
        }

        // æ˜¾ç¤ºä¿®æ”¹ä¸ªäººä¿¡æ¯æ¨¡æ€æ¡†
        function showEditProfileForm() {
            const modal = document.getElementById('edit-profile-modal');
            // å¡«å……å½“å‰ç”¨æˆ·ä¿¡æ¯
            document.getElementById('edit-name').value = currentUser.name || '';
            document.getElementById('edit-department').value = currentUser.department || '';
            document.getElementById('edit-phone').value = currentUser.phone || '';
            document.getElementById('edit-email').value = currentUser.email || '';
            modal.style.display = 'flex';
        }

        // éšè—ä¿®æ”¹ä¸ªäººä¿¡æ¯æ¨¡æ€æ¡†
        function hideEditProfileForm() {
            const modal = document.getElementById('edit-profile-modal');
            modal.style.display = 'none';
        }

        // å¤„ç†ä¿®æ”¹ä¸ªäººä¿¡æ¯è¡¨å•æäº¤
        document.getElementById('edit-profile-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const profileData = Object.fromEntries(formData.entries());

            try {
                const response = await fetch(`${API_BASE}/profile`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(profileData)
                });

                const result = await response.json();
                
                if (response.ok) {
                    showAlert('edit-profile-alert', 'ä¸ªäººä¿¡æ¯æ›´æ–°æˆåŠŸ', 'success');
                    await loadUserProfile(); // é‡æ–°åŠ è½½ç”¨æˆ·ä¿¡æ¯
                    setTimeout(hideEditProfileForm, 1500);
                } else {
                    showAlert('edit-profile-alert', result.error || 'æ›´æ–°å¤±è´¥', 'error');
                }
            } catch (error) {
                showAlert('edit-profile-alert', 'ç½‘ç»œé”™è¯¯', 'error');
            }
        });

        // æ·»åŠ ç”¨æˆ·å†»ç»“/è§£å†»åŠŸèƒ½
        async function toggleUserStatus(user) {
            const newStatus = user.status === 'active' ? 'frozen' : 'active';
            try {
                const response = await fetch(`${API_BASE}/admin/users/${user.id}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ status: newStatus })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    // æ›´æ–°æœ¬åœ°ç”¨æˆ·çŠ¶æ€
                    user.status = newStatus;
                    
                    // è®°å½•æ“ä½œæ—¥å¿—
                    await recordLog(
                        newStatus === 'active' ? 'è§£å†»ç”¨æˆ·' : 'å†»ç»“ç”¨æˆ·',
                        `${newStatus === 'active' ? 'è§£å†»' : 'å†»ç»“'}ç”¨æˆ·ï¼š${user.username}`
                    );
                    
                    // æ›´æ–°å½“å‰è¡Œçš„æ˜¾ç¤º
                    const userRow = document.querySelector(`tr[data-user-id="${user.id}"]`);
                    if (userRow) {
                        // æ›´æ–°çŠ¶æ€åˆ—
                        const statusCell = userRow.querySelector('td:nth-child(7)');
                        if (statusCell) {
                            statusCell.textContent = user.status === 'active' ? 'æ­£å¸¸' : 'å·²å†»ç»“';
                        }
                        
                        // æ›´æ–°æŒ‰é’®
                        const toggleButton = userRow.querySelector('td:last-child button:last-child');
                        if (toggleButton) {
                            toggleButton.textContent = user.status === 'active' ? 'å†»ç»“' : 'è§£å†»';
                            toggleButton.className = `btn ${user.status === 'active' ? 'btn-danger' : 'btn-success'}`;
                            toggleButton.style.padding = '5px 10px';
                            toggleButton.style.fontSize = '14px';
                            
                            // æ›´æ–°æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶å¤„ç†ç¨‹åº
                            toggleButton.onclick = () => toggleUserStatus({
                                ...user,
                                status: newStatus // ä½¿ç”¨æ›´æ–°åçš„çŠ¶æ€
                            });
                        }
                    }
                    
                    showAlert('users-alert', `ç”¨æˆ·${newStatus === 'active' ? 'è§£å†»' : 'å†»ç»“'}æˆåŠŸ`, 'success');
                    await loadLogs(1); // é‡æ–°åŠ è½½æ—¥å¿—
                } else {
                    showAlert('users-alert', result.error || 'æ“ä½œå¤±è´¥', 'error');
                }
            } catch (error) {
                showAlert('users-alert', 'ç½‘ç»œé”™è¯¯', 'error');
            }
        }
    </script>
</body>
</html>